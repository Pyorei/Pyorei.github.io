<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="欢迎来到我的博客！">
<meta property="og:type" content="website">
<meta property="og:title" content="Paliya&#39;s Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Paliya&#39;s Blog">
<meta property="og:description" content="欢迎来到我的博客！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Paliya">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Paliya's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Paliya's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/%E6%B0%B4%E4%B8%8B%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B9%8B%E6%95%B0%E6%8D%AE%E9%9B%86%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/%E6%B0%B4%E4%B8%8B%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B9%8B%E6%95%B0%E6%8D%AE%E9%9B%86%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-20 21:19:35" itemprop="dateModified" datetime="2022-07-20T21:19:35+08:00">2022-07-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="水下目标检测之数据集和数据增强方法"><a href="#水下目标检测之数据集和数据增强方法" class="headerlink" title="水下目标检测之数据集和数据增强方法"></a>水下目标检测之数据集和数据增强方法</h1><p>通过之前对yolov5的简单学习，发现yolov5的训练和调试都比较方便，因此希望将其运用到水下目标检测的任务中。那么首要任务就是寻找比较合适的数据集，考虑到<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30387863/article/details/111934320">水下图像数据集</a>就少的可怜，目前我也只找到3个针对水下目标检测的数据集。</p>
<h3 id="Real-world-Underwater-Image-Enhancement-RUIE"><a href="#Real-world-Underwater-Image-Enhancement-RUIE" class="headerlink" title="Real-world Underwater Image Enhancement(RUIE)"></a>Real-world Underwater Image Enhancement(RUIE)</h3><p>大连理工大学的自制数据集，论文<a target="_blank" rel="noopener" href="https://arxiv.org/abs/1901.05320%EF%BC%8C%E6%95%B0%E6%8D%AE%E9%9B%86https://github.com/dlut-dimt/Realworld-Underwater-Image-Enhancement-RUIE-Benchmark%E3%80%82%E8%AF%A5%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84UTTS%E6%96%87%E4%BB%B6%E5%A4%B9%E6%9C%89%E6%B5%B7%E8%83%86%E5%92%8C%E6%B5%B7%E5%8F%82%E7%9A%84%E6%B0%B4%E4%B8%8B%E5%9B%BE%E5%83%8F%E5%85%B1%E8%AE%A1300%E5%BC%A0%E5%9B%BE%E7%89%87%EF%BC%88%E6%9C%89%E4%B8%80%E5%BC%A0%E4%B8%8D%E5%8F%AF%E7%94%A8%EF%BC%89%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89XML%E6%96%87%E4%BB%B6%E7%9C%81%E5%8E%BB%E4%BA%86%E6%A0%87%E6%B3%A8%E7%9A%84%E8%BF%87%E7%A8%8B%E3%80%82">https://arxiv.org/abs/1901.05320，数据集https://github.com/dlut-dimt/Realworld-Underwater-Image-Enhancement-RUIE-Benchmark。该数据集的UTTS文件夹有海胆和海参的水下图像共计300张图片（有一张不可用），并配有XML文件省去了标注的过程。</a></p>
<p><img src="https://img-blog.csdnimg.cn/973222e5bcb449f38a5e0aee26892822.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="RUIE-labels"></p>
<h3 id="Aquarium-海生物数据集"><a href="#Aquarium-海生物数据集" class="headerlink" title="Aquarium(海生物数据集)"></a>Aquarium(海生物数据集)</h3><p>该数据集为roboflow开源数据集，采用的是但需要科学上网<a target="_blank" rel="noopener" href="https://universe.roboflow.com/brad-dwyer/aquarium-combined/3%EF%BC%8C%E5%85%B1%E8%AE%A1640%E5%BC%A0%E5%9B%BE%E7%89%87%E5%8C%85%E6%8B%AC%E4%BA%867%E7%A7%8D%E6%B5%B7%E6%B4%8B%E7%94%9F%E7%89%A9%EF%BC%8C%E6%AD%A4%E5%A4%96%E6%95%B0%E6%8D%AE%E9%9B%86%E6%9C%89%E5%81%9A%E8%BF%87%E4%BA%86%E6%97%8B%E8%BD%AC%E5%92%8C%E7%BF%BB%E8%BD%AC%E7%AD%89%E5%A2%9E%E5%BC%BA%E5%90%8E%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%8C%E5%A2%9E%E5%BC%BA%E5%90%8E%E5%85%B1%E8%AE%A14670%E5%BC%A0%E5%9B%BE%E7%89%87%EF%BC%8C%E9%85%8D%E5%A4%87%E4%BA%86yolo%E6%A0%BC%E5%BC%8F%E7%9A%84box%E6%96%87%E4%BB%B6%E3%80%82">https://universe.roboflow.com/brad-dwyer/aquarium-combined/3，共计640张图片包括了7种海洋生物，此外数据集有做过了旋转和翻转等增强后的版本，增强后共计4670张图片，配备了yolo格式的box文件。</a></p>
<p><img src="https://img-blog.csdnimg.cn/da0bc25ab9ae46e69e939ba809c14f41.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="labels-Aquarium"></p>
<h3 id="湛江水下目标检测大赛数据集（鹏城汇智）"><a href="#湛江水下目标检测大赛数据集（鹏城汇智）" class="headerlink" title="湛江水下目标检测大赛数据集（鹏城汇智）"></a>湛江水下目标检测大赛数据集（鹏城汇智）</h3><p>2020水下目标检测算法赛<a target="_blank" rel="noopener" href="https://code.ihub.org.cn/projects/1372%EF%BC%8C%E5%92%8CRUIE%E7%9A%84%E5%9B%BE%E7%89%87%E7%B1%BB%E4%BC%BC%EF%BC%8C%E4%BD%86%E5%85%B1%E6%9C%894%E7%B1%BB%E7%9B%AE%E6%A0%87%E7%89%A9%E4%BD%93%EF%BC%88%E6%B5%B7%E5%8F%82%E3%80%81%E6%B5%B7%E8%83%86%E3%80%81%E6%89%87%E8%B4%9D%E5%92%8C%E6%B5%B7%E6%98%9F%EF%BC%89%E5%85%B1%E8%AE%A15544%E5%BC%A0%E5%9B%BE%E7%89%87%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89xml%E6%96%87%E4%BB%B6%E4%BD%86%E7%BC%BA%E5%B0%91%E4%BA%86%E5%9B%BE%E7%89%87%E7%9A%84size%E4%BF%A1%E6%81%AF%E3%80%82">https://code.ihub.org.cn/projects/1372，和RUIE的图片类似，但共有4类目标物体（海参、海胆、扇贝和海星）共计5544张图片，并配有xml文件但缺少了图片的size信息。</a></p>
<p><img src="https://img-blog.csdnimg.cn/a6313e3c5a9b4d38bd08de4c90f0376e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="labels"></p>
<h3 id="数据增强方法"><a href="#数据增强方法" class="headerlink" title="数据增强方法"></a>数据增强方法</h3><p>YOLO自身搭载了masoic和mixup以及copy_paste这三种数据增强的方法，而对于水下图像还需要对图像进行除雾、明暗调整、色彩还原等操作，使得图片包含的信息更加准确。</p>
<ul>
<li><p>defog除雾算法</p>
<p>何恺明的暗通道先验方法，论文<a target="_blank" rel="noopener" href="http://kaiminghe.com/publications/cvpr09.pdf%EF%BC%8C%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84%E5%8D%9A%E5%AE%A2%E6%80%BB%E7%BB%93%E5%BE%88%E5%A4%9A%EF%BC%8C%E5%85%B7%E4%BD%93%E5%8E%9F%E7%90%86%E5%9C%A8%E8%BF%99%E9%87%8C%E4%B8%8D%E5%86%8D%E8%B5%98%E8%BF%B0%EF%BC%8C%E6%80%BB%E4%B9%8B%E6%9A%97%E9%80%9A%E9%81%93%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%95%88%E6%9E%9C%E6%9E%81%E4%BD%B3%EF%BC%8C%E4%BD%86%E8%AE%A1%E7%AE%97%E9%80%9F%E5%BA%A6%E7%9B%B8%E5%AF%B9%E8%BE%83%E6%85%A2%E3%80%82">http://kaiminghe.com/publications/cvpr09.pdf，网络上的博客总结很多，具体原理在这里不再赘述，总之暗通道算法实现的效果极佳，但计算速度相对较慢。</a></p>
</li>
<li><p>clahe限制对比度自适应直方图均衡化</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1667213">CLAHE 限制对比度自适应直方图均衡化</a>通常应用在医学领域，但本质上是解决亮部和暗部信息不足的问题，因此也适用于水下环境，且集成在了opencv中在YOLO的源码中也很容易被调用，位置在增强工具下的hist_equalize方法。论文<a target="_blank" rel="noopener" href="https://www.cs.unc.edu/techreports/90-035.pdf%E3%80%82">https://www.cs.unc.edu/techreports/90-035.pdf。</a></p>
</li>
<li><p>GAN对抗神经网络</p>
<p>对于水下色彩还原分为两种方法，第一种是基于传统光学原理获取环境信息，通过数学计算还原出原本应有的色彩和图像，而第二种是基于对抗神经网络生成正确色彩的图像。具体可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36926037/article/details/109176816">这篇博客</a>，由于基于GAN的图像增强算法是一个独立领域，在此篇不做深入展开。</p>
</li>
</ul>
<p>还有许多对水下图像处理的方法，可以应用在数据集上进行实验，此处我只使用了前面两种，可能后面会单独补充GAN方法，具体效果如下：</p>
<p><img src="https://img-blog.csdnimg.cn/7aeb3f9d2a314c4090ef49c53bef860c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="原图"><strong>原图</strong></p>
<p><img src="https://img-blog.csdnimg.cn/129763d7315e438486be36a5c26e8d13.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="&quot;除雾&quot;"><strong>除雾</strong></p>
<p><img src="https://img-blog.csdnimg.cn/a8ae8274b276419580f9ce75071d2995.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="直方图均衡"><strong>直方图均衡</strong></p>
<p><img src="https://img-blog.csdnimg.cn/35eb49a438de4f508f6dbe56e5adf6b3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="000001"></p>
<p><strong>除雾加直方图均衡</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/%E5%85%B3%E4%BA%8EYOLOv5%E3%80%81YOLOX%E3%80%81YOLOv6%E7%9A%84%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/%E5%85%B3%E4%BA%8EYOLOv5%E3%80%81YOLOX%E3%80%81YOLOv6%E7%9A%84%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-10 23:44:37" itemprop="dateModified" datetime="2022-07-10T23:44:37+08:00">2022-07-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="关于YOLOv5、YOLOX、YOLOv6的分析"><a href="#关于YOLOv5、YOLOX、YOLOv6的分析" class="headerlink" title="关于YOLOv5、YOLOX、YOLOv6的分析"></a>关于YOLOv5、YOLOX、YOLOv6的分析</h1><p>美团的技术团队在最近提出了YOLOv6网络模型，美团在<a target="_blank" rel="noopener" href="https://tech.meituan.com/2022/06/23/yolov6-a-fast-and-accurate-target-detection-framework-is-opening-source.html">技术文档</a>中重点对比了前两代的YOLOv5和YOLOX，以及百度的PP-YOLOE，在对coco数据集的验证中，YOLOv6不仅识别速度更快，且准确度也更高，此次提升的效果巨大。此处，我将尽可能详细地分析YOLOv6于YOLOv5和YOLOX的区别。</p>
<p><img src="https://p0.meituan.net/travelcube/6e04535a78a8e341615ceab2dd474b18144058.png" alt="对比图1"></p>
<p><img src="https://p0.meituan.net/travelcube/ae8d801a76f96eee5ddfd40d13901b0d141917.png" alt="对比图2"></p>
<h2 id="YOLOv5：https-github-com-ultralytics-yolov5"><a href="#YOLOv5：https-github-com-ultralytics-yolov5" class="headerlink" title="YOLOv5：https://github.com/ultralytics/yolov5"></a>YOLOv5：<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5">https://github.com/ultralytics/yolov5</a></h2><p>在2020年，YOLOv4发布不久，YOLOv5就开源面世，因此网络上对YOLOv5的分析已经非常全面，如江大白老师的分析<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/172121380">https://zhuanlan.zhihu.com/p/172121380</a>，但后期YOLOv5又将主干网络中的Focus层换成了标准卷积，作者的解释是模型可导出性的改进，因为现在正式支持YOLOv5在11个不同的后端进行推理，其中许多为新的Conv实现提供了更好的支持，而Focus层是为了更快的初始层启动和更小的mAP影响，但其结果受到硬件设施的影响较大，许多消费卡和一些企业卡（如T4）使用Focus层可以观察到更快的性能，但在其他卡（如V100&#x2F;A100）的实施中卷积的表现会更好。</p>
<p><img src="https://user-images.githubusercontent.com/31005897/172404576-c260dcf9-76bb-4bc8-b6a9-f2d987792583.png" alt="YOLOv5-v6.1"></p>
<p>在最新的6.0&#x2F;6.1版本中（<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/issues/6998#41">官方文档</a>），主干网络和neck中选用了SiLU激活函数，并且修改了SPP模块，选用了更加简洁的SPPF作为neck，避免了三次卷积核的设置，作者也对SPP和SPPF进行了比较，SPPF在不影响mAP的情况下可以获得更快的速度和更少的FLOPs。</p>
<p><img src="https://user-images.githubusercontent.com/26833433/129478335-b221347a-4a52-4173-b378-12d004d7c2cd.png" alt="SPP和SPPF的比较"></p>
<p>在P6版本中的head仍然使用的YOLOv3的检测头,但增加了一个，一定程度上提升了网络的对不同大小目标物检测的精确度。此外，仍然使用了Mosaic、Copy paste等在线数据增强方法，也在训练过程中使用了多尺度训练（0.5-1.5x）、预热和余弦LR调度程序、EMA（指数移动平均线）等方法提升效果。</p>
<h2 id="YOLOX-https-github-com-Megvii-BaseDetection-YOLOX"><a href="#YOLOX-https-github-com-Megvii-BaseDetection-YOLOX" class="headerlink" title="YOLOX: https://github.com/Megvii-BaseDetection/YOLOX"></a>YOLOX: <a target="_blank" rel="noopener" href="https://github.com/Megvii-BaseDetection/YOLOX">https://github.com/Megvii-BaseDetection/YOLOX</a></h2><p>2021年，旷视研究院提出了YOLOX，并发表了论文<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2107.08430">YOLOX: Exceeding YOLO Series in 2021</a>[1]。在论文中，YOLOX所选择的基线是YOLOv3-SPP版本，论文的说法是YOLOv4和YOLOv5已经过优化了，此外由于计算资源有限，各种实际应用中软件支持不足，且YOLOv3仍然是业界使用最广泛的检测器之一。</p>
<p>考虑到YOLOX也出了许多版本，此处我选择YOLOX-S于YOLOv5s的网络结构进行直观的比较。因为其主干网络使用了Focus和CSPDarknet53，且neck部分也采用了FPN+PAN的结构，激活函数也是YOLOv5-v6.0使用的SiLU。关于YOLOX论文中提出的YOLOX-Darknet与YOLOv3的区别，在江大白老师的文章中会更加详细<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/397993315">https://zhuanlan.zhihu.com/p/397993315</a>。</p>
<p><img src="https://vymnfdbwon.cn-02.visual-paradigm.com/rest/diagrams/shares/diagram/a0736986-b6fe-4368-901b-8a41669b6094/preview?p=1" alt="YOLOX-S"><br>YOLOX-S的主要改进是修改了head部分的检测头,引入了Decoupled head解耦头的结构，并使用了anchor free自由锚框的方法，此外还加入了multi positives多正态和SimOTA最优传输等方法完善了预选框的筛选。在训练的方法中也使用了了EMA权值更新、Cosine学习率机制等训练技巧，而在损失函数的部分，YOLOX分别使用IOU损失函数训练reg分支，BCE损失函数训练cls与obj分支。</p>
<ol>
<li>Decoupled head[2]<br>YOLO系列自YOLOv3开始就没有大幅度更改过检测头相关的内容，而解耦头的设计已经在目标检测和目标分类的网络中被验证有效。解耦头有着分类任务和定位任务两个分支，而采用不同的分支进行运算，有利于效果的提升。由于多分支的加入,会导致网络的计算复杂度增高，YOLOX所提出的方案是先使用1×1的卷积进行降维，来加快运算速度和减小模型大小。</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/6601b6f812c744e38c4046041eec3a05.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5pybfg==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="解耦头示例图"></p>
<ol start="2">
<li><p>anchor free[3]<br>YOLOv3,4,5都是使用anchor base的方法来提取候选框，而YOLOX中将原有的3个anchor候选框缩减至1个，即直接由每个location对box的4个参数进行预测。将每个对象的中心位置所在的location视为正样本，并且将每个对象分配到不同的FPN层中，使得每个对象只有一个location进行预测工作，这样的修改同样是减少了GFLOPs并加快了推理速度。</p>
</li>
<li><p>multi positives[3]<br>如果每个对象只有一个location进行预测，会导致正负样本不均衡，且会抑制一些高质量的预测，YOLOX借鉴了FCOS的中心采样策略，将对象中心附近的location也纳入正样本的计算之中，此时每个对象就有了多个正样本的分布。</p>
</li>
<li><p>SimOTA[4]<br>在旷视自己的OTA算法中，他们将标签分配任务看作网络内部的最优传输任务，即多个目标与多个候选框的相互匹配。不同于OTA的是，SimOTA将原本使用的Sinkhorn-Knopp算法替换，使用动态top-k策略去计算最优传输的问题。这样的方法不仅减少了模型的训练时间，而且避免了Sinkhorn-Knopp算法中的额外求解器超参数。</p>
</li>
</ol>
<h2 id="MT-YOLOv6：https-github-com-meituan-YOLOv6"><a href="#MT-YOLOv6：https-github-com-meituan-YOLOv6" class="headerlink" title="MT-YOLOv6：https://github.com/meituan/YOLOv6"></a>MT-YOLOv6：<a target="_blank" rel="noopener" href="https://github.com/meituan/YOLOv6">https://github.com/meituan/YOLOv6</a></h2><p>不同于YOLOX对检测头的修改，YOLOv6对YOLO系列的backbone和neck进行了全新的设计，参考RepVGG[5]网络设计了RepBlock来替代CSPDarknet53模块，基于COCO数据集的实验结果表明基于RepBlock设计的backbone有着更强的表征能力和更高效的GPU利用率。</p>
<p><img src="https://p0.meituan.net/travelcube/9f7878c7872787f9b8706b28e5e7c611237315.png" alt="Rep算子"></p>
<p>RepVGG结构是在训练时进行多分支拓扑，而在进行推理时等效融合为一个3×3的卷积，这样就可以利用多分支训练时高性能的优势，和单路模型推理时速度快、省内存的优点。虽然YOLOv6对backbone的模块做了比较大的修改，但网络的组成变化并不大，仍然是采用单独的RepConv进行图片尺寸的缩放，使用多层RepConv组成的Block进行特征的提取。</p>
<p><img src="https://p0.meituan.net/travelcube/8ec8337d37c2545b8fcf355625854802145939.png" alt="backbone结构"><br>此外，YOLOv6中所有的激活函数都为ReLU，从而提升网络训练的速度，且使用transpose反卷积进行上采样，并将neck中的CSP模块也使用RepBlock进行替代(Rep-PAN)，但仍然保留FPN-PAN的结构，这样的修改使得其训练的收敛速度更快，推理的速度也更快。</p>
<p><img src="https://p0.meituan.net/travelcube/c37c23c37fd094e05e8cab924659a9d9199592.png" alt="Rep-Pan"><br>在head中仍然沿用了YOLOX的解耦头设计，不过并未对各个检测头进行降维的操作，而是选择减少网络的深度来减少各个部分的内存占用。此外，在anchor free的锚框分配策略中也沿用了SimOTA等方法来提升训练速度。参考了SloU边界框回归损失函数来监督网络的学习，通过引入了所需回归之间的向量角度，重新定义了距离损失，有效降低了回归的自由度，加快网络收敛，进一步提升了回归精度。[6]</p>
<p><img src="https://p0.meituan.net/travelcube/9a0fd7ba30522ce3ed24822e51b0e1a8109432.png" alt="decoupled head yolov6"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>随着网络模型向着轻量化的方向改进，YOLO系列融合了RetinaNet、FCOS、RepVGG网络中有效的方法，可以实现非常好的检测效果。关于RepVGG结构，我认为可以运用到各类网络中来加快推理的速度，主要难点是多分支融合方式，如果将原本使用的CSPDarknet53进行Rep融合，是否会得到比YOLOv6更好的结果？YOLOv6使用的tricks看起来都是为了小型网路专门设计，如果当网络深度和宽度进行拓展，ReLU激活函数导致神经元失活是否会导致检测效果的下降？此外，anchor free确实缩减了模型的内存占用，但检测的效果并不如anchor base的方法好，在同样的tricks下，仍然需要比较它们的检测速度和精度，从而选取一个性价比最高的模型进行部署。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>1.YOLOX: Exceeding YOLO Series in 2021<br>2.<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1904.06493v4.pdf">Rethinking Classification and Localization for Object Detection</a><br>3.<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1904.01355.pdf">Fcos: Fully convolutional one-stage object detection</a><br>4.<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2103.14259">OTA: Optimal Transport Assignment for Object Detection</a><br>5.<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2101.03697">RepVGG: Making VGG-style ConvNets Great Again</a><br>6.<a target="_blank" rel="noopener" href="https://arxiv.org/abs/2205.12740">SloU Loss: More Powerful Learning for Bounding Box Regression</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/%E7%99%BE%E5%BA%A6%E9%A3%9E%E6%A1%A8-%E5%B7%A5%E4%B8%9A%E8%AF%BB%E8%A1%A8%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%93%8D%EF%BC%88%E4%BF%AE%E6%94%B9%E8%AF%BB%E8%A1%A8%E8%8C%83%E5%9B%B4%E5%92%8C%E6%95%B0%E5%80%BC%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/%E7%99%BE%E5%BA%A6%E9%A3%9E%E6%A1%A8-%E5%B7%A5%E4%B8%9A%E8%AF%BB%E8%A1%A8%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%93%8D%EF%BC%88%E4%BF%AE%E6%94%B9%E8%AF%BB%E8%A1%A8%E8%8C%83%E5%9B%B4%E5%92%8C%E6%95%B0%E5%80%BC%EF%BC%89/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-20 21:17:32" itemprop="dateModified" datetime="2022-07-20T21:17:32+08:00">2022-07-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="百度飞桨-工业读表案例实操（修改读表范围和数值）"><a href="#百度飞桨-工业读表案例实操（修改读表范围和数值）" class="headerlink" title="百度飞桨-工业读表案例实操（修改读表范围和数值）"></a>百度飞桨-工业读表案例实操（修改读表范围和数值）</h2><p>月初，外面的项目要求做一个工业读表的功能，并给我发来了这个链接<a target="_blank" rel="noopener" href="https://www.paddlepaddle.org.cn/tutorials/projectdetail/3387933%E3%80%82%E8%8A%B1%E4%BA%86%E4%B8%80%E4%BA%9B%E6%97%B6%E9%97%B4%E5%AF%B9%E6%95%99%E7%A8%8B%E8%BF%9B%E8%A1%8C%E4%BA%86%E5%AD%A6%E4%B9%A0%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%A1%88%E4%BE%8B%E4%B8%AD%E7%9A%84%E8%AF%BB%E8%A1%A8%E5%8F%AA%E9%92%88%E5%AF%B9%E4%BA%86%E7%89%B9%E5%AE%9A%E7%9A%84%E4%B8%A4%E7%A7%8D%E8%A1%A8%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%BF%98%E9%9C%80%E8%A6%81%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9%E8%AF%BB%E8%A1%A8%E6%96%B9%E6%B3%95%E3%80%82">https://www.paddlepaddle.org.cn/tutorials/projectdetail/3387933。花了一些时间对教程进行了学习，由于案例中的读表只针对了特定的两种表，因此还需要尝试修改读表方法。</a></p>
<p>由于百度的教程非常详细，所以代码配置问题在此处省略，需要注意的是环境配置必须完全按照教程使用CUDA10.2，否则会导致编译错误，此处只对如何修改读表做出总结。</p>
<h3 id="修改表盘读取范围"><a href="#修改表盘读取范围" class="headerlink" title="修改表盘读取范围"></a>修改表盘读取范围</h3><p>打开meter_reader.cpp可以看到63行处有GetMeterReading方法，ctrl+左键点入该方法的所在位置，是在src&#x2F;reader_postprocess.cpp文件的第233行，而此处也正如教程开始的图片所示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reader_postprocess.cpp    line 233</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">GetMeterReading</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> std::vector&lt;std::vector&lt;<span class="type">uint8_t</span>&gt;&gt; &amp;seg_label_maps,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;<span class="type">float</span>&gt; *readings)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; seg_label_maps.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; rectangle_meter;</span><br><span class="line">    <span class="built_in">CircleToRectangle</span>(seg_label_maps[i], &amp;rectangle_meter);  <span class="comment">// 环形表盘转为矩形</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; line_scale;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; line_pointer;</span><br><span class="line">    <span class="built_in">RectangleToLine</span>(rectangle_meter, &amp;line_scale, &amp;line_pointer);  <span class="comment">// 二维图像转一维数组</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; binaried_scale;</span><br><span class="line">    <span class="built_in">MeanBinarization</span>(line_scale, &amp;binaried_scale);</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; binaried_pointer;</span><br><span class="line">    <span class="built_in">MeanBinarization</span>(line_pointer, &amp;binaried_pointer);  <span class="comment">// 对刻度用均值做二值化</span></span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="type">float</span>&gt; scale_location;</span><br><span class="line">    <span class="built_in">LocateScale</span>(binaried_scale, &amp;scale_location);</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> pointer_location;</span><br><span class="line">    <span class="built_in">LocatePointer</span>(binaried_pointer, &amp;pointer_location);</span><br><span class="line"></span><br><span class="line">    MeterResult result;</span><br><span class="line">    <span class="built_in">GetRelativeLocation</span>(</span><br><span class="line">      scale_location, pointer_location, &amp;result);  <span class="comment">// 定位指针相对刻度的位置</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> reading;</span><br><span class="line">    <span class="built_in">CalculateReading</span>(result, &amp;reading);  <span class="comment">// 根据刻度的根数判断表盘类型和量程，计算读数</span></span><br><span class="line">    readings-&gt;<span class="built_in">push_back</span>(reading);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://ai-studio-static-online.cdn.bcebos.com/e0f75ad956d949bab072cc409568ac731df5196cbf044305835dae0a3a01b7da" alt="流程图"></p>
<p>首先将语义分割的结果经过腐蚀处理后输入，之后使用CircleToRectangle将环形表盘展开为矩形图像，这个方法是修改的关键，因为涉及到这个矩形是从何处开始截取的，即表盘的起始点。该方法在前面的57行：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reader_postprocess.cpp    line 57</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CircleToRectangle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt; &amp;seg_label_map,</span></span></span><br><span class="line"><span class="params"><span class="function">  std::vector&lt;<span class="type">uint8_t</span>&gt; *rectangle_meter)</span> </span>&#123;</span><br><span class="line">  <span class="type">float</span> theta;</span><br><span class="line">  <span class="type">int</span> rho;</span><br><span class="line">  <span class="type">int</span> image_x;</span><br><span class="line">  <span class="type">int</span> image_y;</span><br><span class="line">  <span class="comment">// The minimum scale value is at the bottom left, the maximum scale value</span></span><br><span class="line">  <span class="comment">// is at the bottom right, so the vertical down axis is the starting axis and</span></span><br><span class="line">  <span class="comment">// rotates around the meter ceneter counterclockwise.(Actually it is clockwise)</span></span><br><span class="line">  <span class="comment">// 此处注释也非常清晰，最小刻度值在左下角，最大刻度值在右下角，所以垂直下轴为起始轴，绕仪表中心逆时针旋转（谷歌翻译）。（实际上是顺时针，且代码提供的是顺时针，此处为标注错误）</span></span><br><span class="line">  *rectangle_meter =</span><br><span class="line">    std::<span class="built_in">vector</span>&lt;<span class="type">uint8_t</span>&gt; (RECTANGLE_WIDTH * RECTANGLE_HEIGHT, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> row = <span class="number">0</span>; row &lt; RECTANGLE_HEIGHT; row++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> col = <span class="number">0</span>; col &lt; RECTANGLE_WIDTH; col++) &#123;</span><br><span class="line">      <span class="comment">// 从for循环可以看出，theta是从0-360的，而rho为设定圆周-row，即从最外圈向圆心遍历。</span></span><br><span class="line">      theta = PI * <span class="number">2</span> / RECTANGLE_WIDTH * (col + <span class="number">1</span>);</span><br><span class="line">      rho = CIRCLE_RADIUS - row - <span class="number">1</span>;</span><br><span class="line">      <span class="comment">// 此处对应了图像的y，x坐标，值得注意的是图片的坐标系通常为top-left即左上角，向右为x轴向下为y轴</span></span><br><span class="line">      <span class="comment">// 再次点入CIRCLE_CENTER，会发现在meter_config.cpp中存放了许多信息，在下个代码块会进行标注</span></span><br><span class="line">      <span class="comment">// 重点关注下面两行代码，是修改读表起始点和旋转方向的关键</span></span><br><span class="line">      <span class="type">int</span> y = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(CIRCLE_CENTER[<span class="number">0</span>] + rho * <span class="built_in">cos</span>(theta) + <span class="number">0.5</span>);</span><br><span class="line">      <span class="type">int</span> x = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(CIRCLE_CENTER[<span class="number">1</span>] - rho * <span class="built_in">sin</span>(theta) + <span class="number">0.5</span>);</span><br><span class="line">      (*rectangle_meter)[row * RECTANGLE_WIDTH + col] =</span><br><span class="line">        seg_label_map[y * METER_SHAPE[<span class="number">1</span>] + x];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果想要将表盘起始点改为数值向上，只需要将y坐标改为：</p>
<figure class="highlight plaintext"><figcaption><span>y </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">此外x坐标也需要改为：</span><br><span class="line"></span><br><span class="line">``` int x = static_cast&lt;int&gt;(CIRCLE_CENTER[1] + rho * sin(theta) + 0.5); ```。</span><br><span class="line"></span><br><span class="line">使得y坐标由小变大再变小，x坐标先变大再变小，自绘示例图对照图片的坐标系便很好理解。</span><br><span class="line"></span><br><span class="line">![示意图](https://img-blog.csdnimg.cn/db4036ed664c44bd9b824a5703120974.png#pic_center)</span><br><span class="line"></span><br><span class="line">### 修改读表数值</span><br><span class="line"></span><br><span class="line">在修改完读表范围后，读表数值的修改相对简单一些，首先下面是对meter_config.cpp的标注，后续的更改也是基于这个文件。</span><br><span class="line"></span><br><span class="line">```C++</span><br><span class="line">// meter_config.cpp</span><br><span class="line"></span><br><span class="line">#include &quot;meter_reader/include/meter_config.h&quot;</span><br><span class="line">// METER_SHAPE为图像处理后的大小，与meter_pipeline中resize的尺寸需要对应</span><br><span class="line">std::vector&lt;int&gt; METER_SHAPE = &#123;512, 512&#125;;  // height x width</span><br><span class="line">// CIRCLE_CENTER为表盘中心点，由于目标检测的精度极高，因此为METER_SHAPE中心点即可</span><br><span class="line">std::vector&lt;int&gt; CIRCLE_CENTER = &#123;256, 256&#125;;</span><br><span class="line">// CIRCLE_RADIUS决定了表盘读取的最外圈，如果刻度距离表外径较远则需要调整，通常来说只需要与圆心相加略小于尺寸即可</span><br><span class="line">int CIRCLE_RADIUS = 250;</span><br><span class="line">float PI = 3.1415926536;</span><br><span class="line">// 以下两项为表盘转为矩形的尺寸，比较重要的是HEIGHT，决定了从最外圈到圆心的像素数量，从而截取有刻度的圆环</span><br><span class="line">// WIDTH则决定了360度被分成多少份读取，即转换的精度，但由于像素点是有限的，所以并非越大越好</span><br><span class="line">int RECTANGLE_HEIGHT = 120;</span><br><span class="line">int RECTANGLE_WIDTH = 1570;</span><br><span class="line">// 下面是如果需要检测不同的表盘，如果其刻度线根数相差较大，可以通过修改这个添加检测的表盘数量</span><br><span class="line">// TYPE_THRESHOLD为刻度线根数的阈值，而METER_CONFIG存放了表盘的分度值和量程</span><br><span class="line">int TYPE_THRESHOLD = 40;</span><br><span class="line">// std::vector&lt;int&gt; TYPE_THRESHOLD = &#123;30, 50, 80&#125;;</span><br><span class="line">std::vector&lt;MeterConfig&gt; METER_CONFIG = &#123;</span><br><span class="line">  MeterConfig(25.0f/50.0f, 25.0f, &quot;(MPa)&quot;),</span><br><span class="line">  MeterConfig(1.6f/32.0f,  1.6f,   &quot;(MPa)&quot;),</span><br><span class="line">  MeterConfig(100.0f/100.0f, 100.0f, &quot;(Kg)&quot;)</span><br><span class="line">&#125;;</span><br><span class="line">// 语义分割的标签</span><br><span class="line">std::map&lt;std::string, uint8_t&gt; SEG_CNAME2CLSID = &#123;</span><br><span class="line">  &#123;&quot;background&quot;, 0&#125;, &#123;&quot;pointer&quot;, 1&#125;, &#123;&quot;scale&quot;, 2&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据GetMeterReading方法可知，CalculateReading即最终读表的数值，在reader_postprocess.cpp的201行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reader_postprocess.cpp	line 201</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CalculateReading</span><span class="params">(<span class="type">const</span> MeterResult &amp;result,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">float</span> *reading)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Provide a digital readout according to point location relative</span></span><br><span class="line">  <span class="comment">// to the scales</span></span><br><span class="line">  <span class="keyword">if</span> (result.num_scales_ &gt; TYPE_THRESHOLD) &#123;</span><br><span class="line">    *reading = result.pointed_scale_ * METER_CONFIG[<span class="number">0</span>].scale_interval_value_;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *reading = result.pointed_scale_ * METER_CONFIG[<span class="number">1</span>].scale_interval_value_;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>此处TYPE_THRESHOLD为刻度线根数，如果有多个不同类型的表盘则至少要保证其刻度线根数不一样，从而可以添加多个TYPE_THRESHOLD，并添加多种类型的表盘。如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CalculateReading</span><span class="params">(<span class="type">const</span> MeterResult &amp;result,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">float</span> *reading)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Provide a digital readout according to point location relative</span></span><br><span class="line">  <span class="comment">// to the scales</span></span><br><span class="line">  <span class="keyword">if</span> (result.num_scales_ &gt; TYPE_THRESHOLD[<span class="number">0</span>] &amp;&amp; result.num_scales_ &lt; TYPE_THRESHOLD[<span class="number">1</span>]) &#123;</span><br><span class="line">    *reading = result.pointed_scale_ * METER_CONFIG[<span class="number">0</span>].scale_interval_value_;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.num_scales_ &gt; TYPE_THRESHOLD[<span class="number">1</span>] &amp;&amp; result.num_scales_ &lt; TYPE_THRESHOLD[<span class="number">2</span>])&#123;</span><br><span class="line">    *reading = result.pointed_scale_ * METER_CONFIG[<span class="number">1</span>].scale_interval_value_;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    *reading = result.pointed_scale_ * METER_CONFIG[<span class="number">2</span>].scale_interval_value_;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/%E9%98%BF%E9%87%8C%E5%A4%A9%E6%B1%A0%EF%BC%9A%E5%B0%8F%E6%A0%B7%E6%9C%AC%E5%95%86%E6%A0%87%E6%A3%80%E6%B5%8B%EF%BC%88baseline%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/%E9%98%BF%E9%87%8C%E5%A4%A9%E6%B1%A0%EF%BC%9A%E5%B0%8F%E6%A0%B7%E6%9C%AC%E5%95%86%E6%A0%87%E6%A3%80%E6%B5%8B%EF%BC%88baseline%EF%BC%89/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-20 21:16:24" itemprop="dateModified" datetime="2022-07-20T21:16:24+08:00">2022-07-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="阿里天池：小样本商标检测（baseline0-50）"><a href="#阿里天池：小样本商标检测（baseline0-50）" class="headerlink" title="阿里天池：小样本商标检测（baseline0.50）"></a>阿里天池：小样本商标检测（baseline0.50）</h1><p>在学会YOLO目标检测后第一次参加这样的比赛，特此做个记录，且实验室算力有限，后续不会再对baseline进行改进，此处只提出一些改进的方案。比赛链接：<a target="_blank" rel="noopener" href="https://tianchi.aliyun.com/competition/entrance/531948/introduction">ICME-2022 安全AI挑战者计划第九期：小样本商标检测挑战赛-天池大赛-阿里云天池 (aliyun.com)</a>。比赛规则比较严格，首先只能使用Image 1K的预训练模型，但YOLO自身只提供基于COCO的预训练模型；且不允许使用模型融合，即使用多个模型的预测结果做并集，冲排名的话需要注意。本文需要掌握一定的yolo检测基础，具体的训练命令和检测命令省略。</p>
<h2 id="数据集分析"><a href="#数据集分析" class="headerlink" title="数据集分析"></a>数据集分析</h2><p>首先比赛提供的是COCO格式的数据标注结果，初赛按理说是提供50类商品的每类50张图片，但实际只有2476张，可以参考<a target="_blank" rel="noopener" href="https://github.com/CarryHJR/LogDet/tree/master/LogDetMini/eda">这篇文章</a>做数据集的分析，具体分析结果如下：</p>
<p><img src="https://img-blog.csdnimg.cn/9e704389bc694d18a3c76dcc34f99479.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="天池eda1"></p>
<p>图中可以看出数据集所有图片的宽高和宽高比，大多还是以淘宝商品页的800*800为主，实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os.path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root = <span class="string">&quot;数据集根目录&quot;</span></span><br><span class="line">img_dir = osp.join(root, <span class="string">&#x27;images&#x27;</span>)</span><br><span class="line">img_paths = glob.glob(img_dir + <span class="string">&#x27;/*&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_img_size</span>(<span class="params">img_path</span>):</span><br><span class="line">    image = Image.<span class="built_in">open</span>(img_path)</span><br><span class="line">    w, h = image.size</span><br><span class="line">    <span class="keyword">return</span> w, h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">w_list, h_list, rat_list = [], [], []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> img <span class="keyword">in</span> img_paths:</span><br><span class="line">    w, h = get_img_size(img)</span><br><span class="line">    w_list.append(w)</span><br><span class="line">    h_list.append(h)</span><br><span class="line"></span><br><span class="line">f, ax = plt.subplots(<span class="number">1</span>,<span class="number">3</span>, figsize=(<span class="number">16</span>,<span class="number">4</span>))</span><br><span class="line">sns.histplot(w_list, ax=ax[<span class="number">0</span>], palette=sns.light_palette(<span class="string">&quot;seagreen&quot;</span>, as_cmap=<span class="literal">True</span>)).set_title(<span class="string">&#x27;Width&#x27;</span>)</span><br><span class="line">sns.histplot(h_list, ax=ax[<span class="number">1</span>], palette=sns.color_palette(<span class="string">&quot;RdPu&quot;</span>, <span class="number">10</span>)).set_title(<span class="string">&#x27;Height&#x27;</span>)</span><br><span class="line">sns.histplot(np.array(w_list)/np.array(h_list), ax=ax[<span class="number">2</span>], palette=sns.color_palette(<span class="string">&quot;RdPu&quot;</span>, <span class="number">10</span>)).set_title(<span class="string">&#x27;W&amp;H Ratio&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>对于数据标注的结果分析如下，重点考察bbox的宽高比和面积占比：</p>
<p><img src="https://img-blog.csdnimg.cn/3425d4ac32bb447d972e4ffdafe12118.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5biV6YeM5Lqa,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="bbox长宽比"></p>
<p><code>bbox 小目标(area&lt;%3)占比 统计</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">+------------------------+---------------------+</span><br><span class="line">|         class          |  small object ratio |</span><br><span class="line">+------------------------+---------------------+</span><br><span class="line">|         冰墩墩         | 0.35398230088495575 |</span><br><span class="line">|       Sanyo/三洋       |         1.0         |</span><br><span class="line">|     Eifini/伊芙丽      |         1.0         |</span><br><span class="line">|      PSALTER/诗篇      |  0.9636363636363636 |</span><br><span class="line">|        Beaster         |       0.84375       |</span><br><span class="line">|        ON/昂跑         |  0.9878048780487805 |</span><br><span class="line">|     BYREDO/柏芮朵      |  0.9568965517241379 |</span><br><span class="line">|         Ubras          |         0.98        |</span><br><span class="line">|       Eternelle        |  0.6326530612244898 |</span><br><span class="line">| PERFECT DIARY/完美日记  |  0.8918918918918919 |</span><br><span class="line">|         花西子         |  0.9897959183673469 |</span><br><span class="line">|     Clarins/娇韵诗     |  0.9734513274336283 |</span><br><span class="line">|   L&#x27;occitane/欧舒丹    |  0.9716312056737588 |</span><br><span class="line">|     Versace/范思哲     |  0.8235294117647058 |</span><br><span class="line">|     Mizuno/美津浓      |  0.7520661157024794 |</span><br><span class="line">|      Lining/李宁       |         0.95        |</span><br><span class="line">|    DOUBLE STAR/双星    |  0.5416666666666666 |</span><br><span class="line">|     YONEX/尤尼克斯      |  0.8475609756097561 |</span><br><span class="line">|  Tory Burch/汤丽柏琦    |  0.9105691056910569 |</span><br><span class="line">|       Gucci/古驰       |  0.9432624113475178 |</span><br><span class="line">| Louis Vuitton/路易威登  |  0.9702970297029703 |</span><br><span class="line">|   CARTELO/卡帝乐鳄鱼    |  0.7894736842105263 |</span><br><span class="line">|         JORDAN         |       0.828125      |</span><br><span class="line">|         KENZO          |  0.8148148148148148 |</span><br><span class="line">|       UNDEFEATED       |  0.8936170212765957 |</span><br><span class="line">|       BOY LONDON       |  0.6715328467153284 |</span><br><span class="line">|       TREYO/雀友       |  0.9081632653061225 |</span><br><span class="line">|        carhartt        |  0.9514563106796117 |</span><br><span class="line">|          洁柔          |  0.9771241830065359 |</span><br><span class="line">|     Blancpain/宝珀     |         1.0         |</span><br><span class="line">|          GXG           |         1.0         |</span><br><span class="line">|          乐町          |         1.0         |</span><br><span class="line">|    Diadora/迪亚多纳     | 0.38271604938271603 |</span><br><span class="line">|     TUCANO/啄木鸟       |  0.6031746031746031 |</span><br><span class="line">|         Loewe          |  0.9120879120879121 |</span><br><span class="line">|      Granite Gear      |  0.9813084112149533 |</span><br><span class="line">|    DESCENTE/迪桑特      |         1.0         |</span><br><span class="line">|         OSPREY         |  0.8968253968253969 |</span><br><span class="line">|     Swatch/斯沃琪       |  0.9466666666666667 |</span><br><span class="line">|     erke/鸿星尔克       |  0.8674698795180723 |</span><br><span class="line">|     Massimo Dutti      |  0.9807692307692307 |</span><br><span class="line">|         PINKO          |  0.8390804597701149 |</span><br><span class="line">|       PALLADIUM        |  0.9441624365482234 |</span><br><span class="line">|    origins/悦木之源     |  0.9767441860465116 |</span><br><span class="line">|       Trendiano        |         1.0         |</span><br><span class="line">|          音儿           |         1.0         |</span><br><span class="line">|   Monster Guardians    |  0.9891304347826086 |</span><br><span class="line">|         敷尔佳          |  0.8620689655172413 |</span><br><span class="line">|      IPSA/茵芙莎        |  0.9777777777777777 |</span><br><span class="line">|   Schwarzkopf/施华蔻    |  0.954954954954955  |</span><br><span class="line">|          all           |  0.8899438093392753 |</span><br><span class="line">+------------------------+---------------------+</span><br></pre></td></tr></table></figure>

<p>具体实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># refer: https://github.com/CarryHJR/LogDet/blob/master/LogDetMini/eda/eda.ipynb</span></span><br><span class="line"><span class="keyword">import</span> os.path <span class="keyword">as</span> osp</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root = <span class="string">&quot;json文件所在的根目录&quot;</span></span><br><span class="line">json_path = osp.join(root, <span class="string">&#x27;instances_train2017.json&#x27;</span>)</span><br><span class="line">coco = COCO(json_path) <span class="comment"># 此处可能会报错，需要再coco的jsonload语句下添加encoding=&#x27;utf-8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;bbox 小目标(area&lt;%3)占比 统计&#x27;</span>)</span><br><span class="line">class_names = []</span><br><span class="line">wh_ratios_cls = []</span><br><span class="line"><span class="keyword">for</span> cat_id <span class="keyword">in</span> coco.cats:</span><br><span class="line">    wh_ratios = []</span><br><span class="line">    <span class="keyword">for</span> ann_id <span class="keyword">in</span> coco.getAnnIds(catIds=[cat_id]):</span><br><span class="line">        ann = coco.anns[ann_id]</span><br><span class="line">        image_id = ann[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line">        w_ratio = ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">2</span>] / coco.imgs[image_id][<span class="string">&#x27;width&#x27;</span>]</span><br><span class="line">        h_ratio = ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">3</span>] / coco.imgs[image_id][<span class="string">&#x27;height&#x27;</span>]</span><br><span class="line">        wh_ratios.append([w_ratio, h_ratio])</span><br><span class="line">    wh_ratios = np.array(wh_ratios)</span><br><span class="line">    wh_ratios[:, -<span class="number">1</span>] = wh_ratios[:, <span class="number">0</span>] * wh_ratios[:, <span class="number">1</span>]</span><br><span class="line">    class_names.append(coco.cats[cat_id][<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">    wh_ratios_cls.append((wh_ratios[:,-<span class="number">1</span>]&lt;<span class="number">0.03</span>).<span class="built_in">sum</span>() / wh_ratios.shape[<span class="number">0</span>]) <span class="comment"># 此处可以调整阈值</span></span><br><span class="line"></span><br><span class="line">wh_ratios = []</span><br><span class="line"><span class="keyword">for</span> _, ann <span class="keyword">in</span> coco.anns.items():</span><br><span class="line">    image_id = ann[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line">    w_ratio = ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">2</span>] / coco.imgs[image_id][<span class="string">&#x27;width&#x27;</span>]</span><br><span class="line">    h_ratio = ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">3</span>] / coco.imgs[image_id][<span class="string">&#x27;height&#x27;</span>]</span><br><span class="line">    wh_ratios.append([w_ratio, h_ratio])</span><br><span class="line">wh_ratios = np.array(wh_ratios)</span><br><span class="line">wh_ratios[:, -<span class="number">1</span>] = wh_ratios[:, <span class="number">0</span>] * wh_ratios[:, <span class="number">1</span>]</span><br><span class="line">class_names.append(<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">wh_ratios_cls.append((wh_ratios[:,-<span class="number">1</span>]&lt;<span class="number">0.03</span>).<span class="built_in">sum</span>() / wh_ratios.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable</span><br><span class="line">table_data = PrettyTable()</span><br><span class="line">table_data.add_column(<span class="string">&#x27;class&#x27;</span>, class_names)</span><br><span class="line">table_data.add_column(<span class="string">&#x27;small object ratio&#x27;</span>, wh_ratios_cls)</span><br><span class="line"><span class="built_in">print</span>(table_data.get_string())</span><br><span class="line"></span><br><span class="line">bbox_wh = [<span class="built_in">round</span>(<span class="built_in">max</span>(ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">2</span>], ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">3</span>]) / <span class="built_in">min</span>(ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">2</span>], ann[<span class="string">&#x27;bbox&#x27;</span>][<span class="number">3</span>]), <span class="number">0</span>) <span class="keyword">for</span> _, ann <span class="keyword">in</span> coco.anns.items()]</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">bbox_wh_unique = <span class="built_in">list</span>(<span class="built_in">set</span>(bbox_wh))</span><br><span class="line">bbox_wh_count=[bbox_wh.count(i) <span class="keyword">for</span> i <span class="keyword">in</span> bbox_wh_unique]</span><br><span class="line">k = <span class="number">10</span></span><br><span class="line">wh_df = pd.DataFrame(bbox_wh_count[:k], index=bbox_wh_unique[:k])</span><br><span class="line">wh_df.plot(kind=<span class="string">&#x27;bar&#x27;</span>,color=<span class="string">&quot;#55aacc&quot;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<h2 id="JSON2YOLO"><a href="#JSON2YOLO" class="headerlink" title="JSON2YOLO"></a>JSON2YOLO</h2><p>YOLOv5的源码对数据集的要求时txt格式，源码的团队也有写转换的方法<a target="_blank" rel="noopener" href="https://github.com/ultralytics/JSON2YOLO">ultralytics&#x2F;JSON2YOLO: Convert JSON annotations into YOLO format. (github.com)</a>，此处我实现的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#COCO 格式的数据集转化为 YOLO 格式的数据集</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"> </span><br><span class="line">json_path = <span class="string">&#x27;json文件的地址&#x27;</span></span><br><span class="line">save_path = <span class="string">&#x27;txt文件保存地址&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">size, box</span>):</span><br><span class="line">    dw = <span class="number">1.</span> / (size[<span class="number">0</span>])</span><br><span class="line">    dh = <span class="number">1.</span> / (size[<span class="number">1</span>])</span><br><span class="line">    x = box[<span class="number">0</span>] + box[<span class="number">2</span>] / <span class="number">2.0</span></span><br><span class="line">    y = box[<span class="number">1</span>] + box[<span class="number">3</span>] / <span class="number">2.0</span></span><br><span class="line">    w = box[<span class="number">2</span>]</span><br><span class="line">    h = box[<span class="number">3</span>]</span><br><span class="line">	<span class="comment"># round函数确定(xmin, ymin, xmax, ymax)的小数位数</span></span><br><span class="line">    x = <span class="built_in">round</span>(x * dw, <span class="number">6</span>)</span><br><span class="line">    w = <span class="built_in">round</span>(w * dw, <span class="number">6</span>)</span><br><span class="line">    y = <span class="built_in">round</span>(y * dh, <span class="number">6</span>)</span><br><span class="line">    h = <span class="built_in">round</span>(h * dh, <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">return</span> (x, y, w, h)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    json_file = json_path <span class="comment"># COCO Object Instance 类型的标注</span></span><br><span class="line">    ana_txt_save_path = save_path  <span class="comment"># 保存的路径</span></span><br><span class="line"> </span><br><span class="line">    data = json.load(<span class="built_in">open</span>(json_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(ana_txt_save_path):</span><br><span class="line">        os.makedirs(ana_txt_save_path)</span><br><span class="line"> <span class="comment"># 因为json文件的类别id从1开始，所以此处做了一下重映射，并将类别存入了classes.txt文件下，当然也可以不保存文件；同样的也可以不做重映射，那样类别数量为51，因为id0为空</span></span><br><span class="line">    id_map = &#123;&#125; </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(ana_txt_save_path, <span class="string">&#x27;classes.txt&#x27;</span>), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i, category <span class="keyword">in</span> <span class="built_in">enumerate</span>(data[<span class="string">&#x27;categories&#x27;</span>]):</span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;category[<span class="string">&#x27;name&#x27;</span>]&#125;</span>\n&quot;</span>)</span><br><span class="line">            id_map[category[<span class="string">&#x27;id&#x27;</span>]] = i</span><br><span class="line">    <span class="built_in">print</span>(id_map)</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(data[<span class="string">&#x27;images&#x27;</span>]):</span><br><span class="line">        filename = img[<span class="string">&quot;file_name&quot;</span>]</span><br><span class="line">        img_width = img[<span class="string">&quot;width&quot;</span>]</span><br><span class="line">        img_height = img[<span class="string">&quot;height&quot;</span>]</span><br><span class="line">        img_id = img[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        head, tail = os.path.splitext(filename)</span><br><span class="line">        ana_txt_name = head + <span class="string">&quot;.txt&quot;</span>  <span class="comment"># 对应的txt名字，与jpg一致</span></span><br><span class="line">        f_txt = <span class="built_in">open</span>(os.path.join(ana_txt_save_path, ana_txt_name), <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> ann <span class="keyword">in</span> data[<span class="string">&#x27;annotations&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> ann[<span class="string">&#x27;image_id&#x27;</span>] == img_id:</span><br><span class="line">                box = convert((img_width, img_height), ann[<span class="string">&quot;bbox&quot;</span>])</span><br><span class="line">                f_txt.write(<span class="string">&quot;%s %s %s %s %s\n&quot;</span> % (id_map[ann[<span class="string">&quot;category_id&quot;</span>]], box[<span class="number">0</span>], box[<span class="number">1</span>], box[<span class="number">2</span>], box[<span class="number">3</span>]))</span><br><span class="line">        f_txt.close()</span><br></pre></td></tr></table></figure>

<p>最后提交检测结果的json文件时需要注意自己的类别id和比赛要求是否对应的上，否则会导致提交结果的成绩错误。</p>
<h2 id="数据集离线增强"><a href="#数据集离线增强" class="headerlink" title="数据集离线增强"></a>数据集离线增强</h2><p>小样本很容易就想到了数据增强，包括但不限于添加噪点、图片的旋转平移、mosaic、copy_paste等等，yolov5本身自带了数据集的在线增强，但缺少了数据扩充，因此姑且是做了旋转的增强，且将图片按照类别名做了重命名。实现的方法代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要对训练集进行增强，将train和val</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">root_path = <span class="string">&quot;数据集根目录&quot;</span></span><br><span class="line">image_p = <span class="string">&quot;images&quot;</span></span><br><span class="line">label_p = <span class="string">&quot;labels&quot;</span></span><br><span class="line">image_path = os.path.join(root_path, image_p)</span><br><span class="line">label_path = os.path.join(root_path, label_p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得对应类别的图片以及便签名</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_same_class</span>(<span class="params">label_path, <span class="built_in">id</span></span>):</span><br><span class="line">    label = os.listdir(label_path)</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> label:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(label_path, l), <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            temp = f.read().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> temp[<span class="number">0</span>] == <span class="built_in">id</span>:</span><br><span class="line">                result.append(l.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">                f.close()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f.close()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将文件名重新按（类别_编号）的形式命名</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_file_name</span>():</span><br><span class="line">    class_list = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">50</span>)):</span><br><span class="line">        class_list.append(find_same_class(os.path.join(root_path, label_p), i.__str__()))</span><br><span class="line">    k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> tqdm(class_list):</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> temp <span class="keyword">in</span> j:</span><br><span class="line">            os.rename(os.path.join(image_path, temp + <span class="string">&quot;.jpg&quot;</span>), os.path.join(image_path, <span class="string">&quot;&#123;&#125;_&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(k, n)))</span><br><span class="line">            os.rename(os.path.join(label_path, temp + <span class="string">&quot;.txt&quot;</span>), os.path.join(label_path, <span class="string">&quot;&#123;&#125;_&#123;&#125;.txt&quot;</span>.<span class="built_in">format</span>(k, n)))</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片旋转，此处只做了90、180和270的旋转</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_rotation</span>(<span class="params">path=image_path, angle=<span class="number">90</span></span>):</span><br><span class="line">    image_list = os.listdir(path)</span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> tqdm(image_list):</span><br><span class="line">        <span class="keyword">if</span> img.split(<span class="string">&#x27;_&#x27;</span>).__len__() != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        img_p = os.path.join(path, img)</span><br><span class="line">        res_name = img.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&quot;_rot&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(angle)</span><br><span class="line">        temp = cv2.imread(img_p)</span><br><span class="line">        <span class="keyword">if</span> angle == <span class="number">90</span>:</span><br><span class="line">            result = cv2.rotate(temp, cv2.ROTATE_90_CLOCKWISE)</span><br><span class="line">        <span class="keyword">elif</span> angle == <span class="number">180</span>:</span><br><span class="line">            result = cv2.rotate(temp, cv2.ROTATE_180)</span><br><span class="line">        <span class="keyword">elif</span> angle == <span class="number">270</span>:</span><br><span class="line">            result = cv2.rotate(temp, cv2.ROTATE_90_COUNTERCLOCKWISE)</span><br><span class="line">        cv2.imwrite(os.path.join(path, res_name), result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotation</span>(<span class="params">x, y, angle</span>):</span><br><span class="line">    <span class="comment"># x, y坐标变成图片中心点，标准坐标轴</span></span><br><span class="line">    x = x - <span class="number">0.5</span></span><br><span class="line">    y = -<span class="number">1</span> * (y - <span class="number">0.5</span>)</span><br><span class="line">    pt = np.array([x, y])</span><br><span class="line">    ang = np.pi * angle/<span class="number">180</span></span><br><span class="line">    <span class="comment"># 设定旋转矩阵</span></span><br><span class="line">    M = np.zeros((<span class="number">2</span>, <span class="number">2</span>), dtype=<span class="built_in">float</span>)</span><br><span class="line">    <span class="comment"># 设定旋转角度</span></span><br><span class="line">    alpha = np.cos(ang)</span><br><span class="line">    beta = np.sin(ang)</span><br><span class="line">    <span class="comment"># 初始化旋转矩阵</span></span><br><span class="line">    M[<span class="number">0</span>, <span class="number">0</span>] = alpha</span><br><span class="line">    M[<span class="number">1</span>, <span class="number">1</span>] = alpha</span><br><span class="line">    M[<span class="number">0</span>, <span class="number">1</span>] = beta</span><br><span class="line">    M[<span class="number">1</span>, <span class="number">0</span>] = -beta</span><br><span class="line">    [nx, ny] = M @ pt</span><br><span class="line">    <span class="comment"># 还原x, y到图片坐标系</span></span><br><span class="line">    nx = nx + <span class="number">0.5</span></span><br><span class="line">    ny = -<span class="number">1</span> * ny + <span class="number">0.5</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(nx), <span class="built_in">str</span>(ny)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 旋转90度和270度时需要交换w和h</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">switch_p</span>(<span class="params">w, h</span>):</span><br><span class="line">    <span class="keyword">return</span> h, w</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 标签的坐标旋转，x、y、w、h</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">label_rotation</span>(<span class="params">path=label_path, angle=<span class="number">90</span></span>):</span><br><span class="line">    label_list = os.listdir(path)</span><br><span class="line">    <span class="keyword">for</span> lab <span class="keyword">in</span> tqdm(label_list):</span><br><span class="line">        <span class="keyword">if</span> lab.split(<span class="string">&#x27;_&#x27;</span>).__len__() != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        save_name = lab.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(path, lab), <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            write_label = []</span><br><span class="line">            label = f.readlines()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> label:</span><br><span class="line">                temp = i.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                temp[<span class="number">4</span>] = temp[<span class="number">4</span>].split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                temp[<span class="number">1</span>] , temp[<span class="number">2</span>] = rotation(<span class="built_in">float</span>(temp[<span class="number">1</span>]), <span class="built_in">float</span>(temp[<span class="number">2</span>]), angle)</span><br><span class="line">                <span class="keyword">if</span> angle != <span class="number">180</span>:</span><br><span class="line">                	temp[<span class="number">3</span>] , temp[<span class="number">4</span>] = switch_p(temp[<span class="number">3</span>], temp[<span class="number">4</span>])</span><br><span class="line">                s = <span class="built_in">str</span>.join(<span class="string">&#x27; &#x27;</span>, temp)</span><br><span class="line">                write_label.append(s)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(path, <span class="string">&quot;&#123;&#125;_rot&#123;&#125;.txt&quot;</span>.<span class="built_in">format</span>(save_name, angle)), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> nf:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> write_label:</span><br><span class="line">                nf.write(line+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;_rot&#123;&#125;.txt,done&quot;</span>.<span class="built_in">format</span>(save_name, angle))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="数据分割"><a href="#数据分割" class="headerlink" title="数据分割"></a>数据分割</h2><p>由于做了数据增强，感觉yolov5的autosplit有点不够看了，很容易造成过拟合，即测试集和训练集部分重合，因此我做了一个特殊的分割，按照每类进行划分，得益于文件重命名的原因，这个方法写的非常简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">root_path = <span class="string">&#x27;数据集根目录&#x27;</span></span><br><span class="line">image_path = os.path.join(root_path, <span class="string">&quot;images&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单个类下的图片总数为num，weights为train和val的分割，此处偷懒将所有类别的图片均设置为50张，实际可以根据上面的find_same_class方法读取每一类的图片数量</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_id</span>(<span class="params">num=<span class="number">50</span>, weights=(<span class="params"><span class="number">0.8</span>, <span class="number">0.2</span></span>)</span>):</span><br><span class="line">    <span class="built_in">len</span> = num * weights[<span class="number">0</span>]</span><br><span class="line">    num_list = []</span><br><span class="line">    val_list = []</span><br><span class="line">    <span class="keyword">while</span> num_list.__len__() &lt; <span class="built_in">len</span>:</span><br><span class="line">        random_num = <span class="built_in">int</span>(num * random.random())</span><br><span class="line">        <span class="keyword">if</span> num_list.count(random_num) == <span class="number">0</span>:</span><br><span class="line">            num_list.append(random_num)</span><br><span class="line">    num_list.sort()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        <span class="keyword">if</span> num_list.count(i) == <span class="number">0</span>:</span><br><span class="line">            val_list.append(i)</span><br><span class="line">    <span class="keyword">return</span> num_list, val_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据重命名的图片文件，使得样本均衡</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_split</span>(<span class="params">path=image_path, weights=(<span class="params"><span class="number">0.8</span>, <span class="number">0.2</span></span>)</span>):</span><br><span class="line">    train_list = []</span><br><span class="line">    val_list = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">50</span>)):</span><br><span class="line">        t, v = random_id(<span class="number">50</span>, weights)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> t:</span><br><span class="line">            train_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(i, k))</span><br><span class="line">            train_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot90.jpg&quot;</span>.<span class="built_in">format</span>(i, k))</span><br><span class="line">            train_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot180.jpg&quot;</span>.<span class="built_in">format</span>(i, k))</span><br><span class="line">            train_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot270.jpg&quot;</span>.<span class="built_in">format</span>(i, k))</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> v:</span><br><span class="line">            val_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(i, m))</span><br><span class="line">            val_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot90.jpg&quot;</span>.<span class="built_in">format</span>(i, m))</span><br><span class="line">            val_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot180.jpg&quot;</span>.<span class="built_in">format</span>(i, m))</span><br><span class="line">            val_list.append(<span class="string">&quot;&#123;&#125;_&#123;&#125;_rot270.jpg&quot;</span>.<span class="built_in">format</span>(i, m))</span><br><span class="line">    txt = [<span class="string">&#x27;train.txt&#x27;</span>, <span class="string">&#x27;val.txt&#x27;</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(root_path, txt[<span class="number">0</span>]), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(train_list.__len__()):</span><br><span class="line">            f.write(<span class="string">&#x27;./images/&#123;&#125;\n&#x27;</span>.<span class="built_in">format</span>(train_list[n]))  <span class="comment"># add image to txt file</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(root_path, txt[<span class="number">1</span>]), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(val_list.__len__()):</span><br><span class="line">            f.write(<span class="string">&#x27;./images/&#123;&#125;\n&#x27;</span>.<span class="built_in">format</span>(val_list[n]))  <span class="comment"># add image to txt file</span></span><br></pre></td></tr></table></figure>

<h2 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h2><p>YOLO源码需要编写一个yaml文件指向数据集，文件内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">E:\Document\tianchi\dataset\ali_train\train\train.txt</span>  <span class="comment"># train images</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">E:\Document\tianchi\dataset\ali_train\train\val.txt</span>	  <span class="comment"># val images</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nc:</span> <span class="number">50</span>  <span class="comment"># number of classes 如果没有做重映射，即id从1开始的话，nc=51，在names前加一个空类&#x27;&#x27;</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;冰墩墩&#x27;</span>, <span class="string">&#x27;Sanyo/三洋&#x27;</span>, <span class="string">&#x27;Eifini/伊芙丽&#x27;</span>, <span class="string">&#x27;PSALTER/诗篇&#x27;</span>, <span class="string">&#x27;Beaster&#x27;</span>, <span class="string">&#x27;ON/昂跑&#x27;</span>, <span class="string">&#x27;BYREDO/柏芮朵&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Ubras&#x27;</span>, <span class="string">&#x27;Eternelle&#x27;</span>, <span class="string">&#x27;PERFECT DIARY/完美日记&#x27;</span>, <span class="string">&#x27;花西子&#x27;</span>, <span class="string">&#x27;Clarins/娇韵诗&#x27;</span>, <span class="string">&quot;L&#x27;occitane/欧舒丹&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;Versace/范思哲&#x27;</span>, <span class="string">&#x27;Mizuno/美津浓&#x27;</span>, <span class="string">&#x27;Lining/李宁&#x27;</span>, <span class="string">&#x27;DOUBLE STAR/双星&#x27;</span>, <span class="string">&#x27;YONEX/尤尼克斯&#x27;</span>, <span class="string">&#x27;Tory Burch/汤丽柏琦&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Gucci/古驰&#x27;</span>, <span class="string">&#x27;Louis Vuitton/路易威登&#x27;</span>, <span class="string">&#x27;CARTELO/卡帝乐鳄鱼&#x27;</span>, <span class="string">&#x27;JORDAN&#x27;</span>, <span class="string">&#x27;KENZO&#x27;</span>, <span class="string">&#x27;UNDEFEATED&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BOY LONDON&#x27;</span>, <span class="string">&#x27;TREYO/雀友&#x27;</span>, <span class="string">&#x27;carhartt&#x27;</span>, <span class="string">&#x27;洁柔&#x27;</span>, <span class="string">&#x27;Blancpain/宝珀&#x27;</span>, <span class="string">&#x27;GXG&#x27;</span>, <span class="string">&#x27;乐町&#x27;</span>, <span class="string">&#x27;Diadora/迪亚多纳&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TUCANO/啄木鸟&#x27;</span>, <span class="string">&#x27;Loewe&#x27;</span>, <span class="string">&#x27;Granite Gear&#x27;</span>, <span class="string">&#x27;DESCENTE/迪桑特&#x27;</span>, <span class="string">&#x27;OSPREY&#x27;</span>, <span class="string">&#x27;Swatch/斯沃琪&#x27;</span>, <span class="string">&#x27;erke/鸿星尔克&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Massimo Dutti&#x27;</span>, <span class="string">&#x27;PINKO&#x27;</span>, <span class="string">&#x27;PALLADIUM&#x27;</span>, <span class="string">&#x27;origins/悦木之源&#x27;</span>, <span class="string">&#x27;Trendiano&#x27;</span>, <span class="string">&#x27;音儿&#x27;</span>, <span class="string">&#x27;Monster Guardians&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;敷尔佳&#x27;</span>, <span class="string">&#x27;IPSA/茵芙莎&#x27;</span>, <span class="string">&#x27;Schwarzkopf/施华蔻&#x27;</span>]  <span class="comment"># class names</span></span><br></pre></td></tr></table></figure>

<p>做完上述内容后，就可以进行YOLOv5模型的训练了，本文使用了YOLOv5s和YOLOv5m6两种，优点是官方都提供了基于COCO的预训练模型，且yolov5m6设计了4个检测框，理论上会有一定的提升，实验结果也确实如此。本文使用官方的yolov5m6作为baseline，本地测试mAP为0.56，线上测试mAP为0.50，而yolov5s的线上成绩只有0.48。</p>
<p>更进一步的改进可以参考对于小目标检测的遥感方向的目标检测方案，如TPH-YOLO在检测头上引入了Transformer增强，还有YOLO-Z使用了Bi-FPN等，但由于没有预训练模型，因此直接训练的效果可能会不及yolov5m6。由于这次比赛不考虑检测时间，因此应该是Transformer大放异彩的时刻，此外RCNN的效果应该也会更好。</p>
<h2 id="成绩提交"><a href="#成绩提交" class="headerlink" title="成绩提交"></a>成绩提交</h2><p>比赛是提交json文件进行考核，使用val.py自带的save-json方法生成即可，但需要对图片的id进行重映射，参考官方的提交规范可知，image-id需要从测试集的json文件中读取，本文直接采取暴力重命名的方法，重映射的方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">json_path = <span class="string">&#x27;json文件路径&#x27;</span></span><br><span class="line">img_path = <span class="string">&#x27;测试集图片根目录&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    json_file = json_path</span><br><span class="line">    data = json.load(<span class="built_in">open</span>(json_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    id_map = &#123;&#125; <span class="comment"># id和图片的映射</span></span><br><span class="line">    <span class="keyword">for</span> category <span class="keyword">in</span> <span class="built_in">enumerate</span>(data[<span class="string">&#x27;images&#x27;</span>]):</span><br><span class="line">        file_name = category[<span class="number">1</span>][<span class="string">&#x27;file_name&#x27;</span>]</span><br><span class="line">        <span class="built_in">id</span> = category[<span class="number">1</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        id_map[<span class="built_in">id</span>] = file_name</span><br><span class="line">    <span class="comment"># 对图片进行重命名</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> id_map:</span><br><span class="line">        img_path = os.path.join(arg.img_path, id_map[i])</span><br><span class="line">        output_path = os.path.join(arg.img_path, <span class="string">&quot;&#123;&#125;.jpg&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        os.rename(img_path, output_path)</span><br></pre></td></tr></table></figure>

<p>此外还需要准备一个yaml指向测试集图片，即更改yaml文件下的val地址，这样就可以使用val.py直接进行结果的生成了，需要注意的是如果做了重映射会导致类别id对应不上（偏了1），需要在save_json方法下进行修改，使读取的类别id+1保证检测结果的有效性。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次比赛算是一次对于之前学习成果的检验，并发现自身的不足。受限于算力不足，许多网络模型甚至没有办法运行，采用大的网络则需要减少batch的大小，十分影响效率和结果，且本文是基于yolov5源码做的比赛，实在是费劲，且只能做消融实验，确实有些不够用了。这里推荐学习官方使用的mmdetection，不仅可以直接使用RCNN、SDD等网络进行检测，修改特征提取的主干网络也比较容易，后续我也会对学习mmdetection做出自己的总结。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/yolov5%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/yolov5%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-12 14:09:39" itemprop="dateModified" datetime="2022-03-12T14:09:39+08:00">2022-03-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="yolov5目标检测"><a href="#yolov5目标检测" class="headerlink" title="yolov5目标检测"></a>yolov5目标检测</h1><p>yolov1到v4的论文在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39524959/article/details/111136986">这篇文章</a>里比较详细，此处不对其网络做更深入的介绍，重点在于如何训练以及如何用训练好的模型做检测。以下内容参考了<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5">源码</a>提供的教程，是对此前工作的技术总结。</p>
<h2 id="yolov5的安装与配置"><a href="#yolov5的安装与配置" class="headerlink" title="yolov5的安装与配置"></a>yolov5的安装与配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ultralytics/yolov5  # 下载源码</span><br><span class="line">cd yolov5</span><br><span class="line">pip install -r requirements.txt  # 安装所需要的环境</span><br></pre></td></tr></table></figure>

<p>yolov5需要python3.7以上的环境版本，如果需要使用gpu加速，还需要安装英伟达的cuda，具体流程可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/beifangc/article/details/108967239">这篇文章</a>。</p>
<h2 id="yolov5自定义数据集训练"><a href="#yolov5自定义数据集训练" class="headerlink" title="yolov5自定义数据集训练"></a>yolov5自定义数据集训练</h2><p>首先是数据集的建立，数据集由训练集、测试集的图像以及标签组成，当然可以手动编写标签，以矩形框为例，格式为’class x y w h‘，分别代表目标框的类别、归一化后的x坐标以及y坐标，以及目标框的宽和高。<a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov5/wiki/Train-Custom-Data">官方</a>使用的是Roboflow网页标签工具，国内推荐使用<a target="_blank" rel="noopener" href="https://www.makesense.ai/">Make Sense</a>作为替代，或者是<a target="_blank" rel="noopener" href="https://www.cnblogs.com/StarZhai/p/11926610.html">使用labelImg标注数据</a>。</p>
<p>图片</p>
<p>生成数据集标签后，需要建立数据集文件夹以及yaml配置文件，其中images与labels内部的文件夹名需要对应，用于存放训练集和测试集的图片与标签，内部的文件名也需要一一对应</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#文件夹配置</span><br><span class="line">E:mydata\</span><br><span class="line">├─images</span><br><span class="line">│  ├─test</span><br><span class="line">|    ├─01.jpg</span><br><span class="line">│  └─train</span><br><span class="line">└─labels</span><br><span class="line">    ├─test</span><br><span class="line">      ├─01.txt</span><br><span class="line">    └─train</span><br></pre></td></tr></table></figure>

<p>此外需要建立一个yaml配置文件方便yolo源码的调用，其中包含了训练集与测试集的绝对路径，以及数据集的类别数和名称，配置文件存放在源码的data文件夹下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">train:</span> <span class="string">E:\mydata\images\train</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">E:\mydata\images\test</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>然后就是对源码的train.py文件进行配置，可以使用ide进行参数配置，也可以在控制台手动输入各种参数。其中img代表输入图像尺寸，batch为处理图像数量，epochs为迭代次数（默认为300），data为之前编写的配置文件，weights为权重模型。其余还有许多参数，分别代表什么可以查看源码，也可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41990671/article/details/107300314">这篇文章</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python train.py --img 640 --batch 16 --epochs 3 --data mydata.yaml --weights yolov5s.pt</span><br></pre></td></tr></table></figure>

<p>训练的时候会遇到内存不足的情况，可以尝试将batch改小，即一次处理的图片数量，或是增加电脑的虚拟内存，再不行可以将train.py内dataloader的num_workers参数修改为0。训练完成后会将最好的一次模型和最后一次模型以及各类数据存放在run\train文件夹内，有可能会遇到300次迭代仍得不到好的结果的情况，此时可以将best.pt存放到yolov5的根目录下，并使用best.pt进行下一次训练。</p>
<h1 id="yolov5检测验证"><a href="#yolov5检测验证" class="headerlink" title="yolov5检测验证"></a>yolov5检测验证</h1><p>detect.py为目标检测的执行文件，与train步骤类似，可以使用ide配置参数，也可以在控制台输入命令，其中weights为权重模型，source为检测对象，运行完成后会将结果存放在run\detect文件夹下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python path/to/detect.py --weights yolov5s.pt --source 0			#摄像头编号</span><br><span class="line">													   img.jpg		#图片</span><br><span class="line">													   vid.mp4		#视频</span><br><span class="line">													   path			#路径下所有图</span><br><span class="line">													   path/*.jpg	#指定类型图片</span><br></pre></td></tr></table></figure>

<p>还有许多其它参数可以调节，比如save-txt是保存文字结果，conf-thres为置信度阈值，iou-thres为NMS的iou阈值，具体可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/Q1u1NG/article/details/108093525">这篇文章</a>。</p>
<h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><p>由于可以保存txt文件，包含了类别以及xywh和置信度这些信息，结合先前的摄像机标定等工作可以得出检测对象的三维坐标，便于后续运动规划等任务。或者对detect源文件进行补充，添加ros的通信功能，方便后续的开发。yolov5的内容非常的丰富，有许多地方值得深究和修改，比如对于重复的多目标识别的任务中表现欠佳，这也是后续我工作的重点方向。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/XML%E6%96%87%E4%BB%B6%E8%BD%ACTXT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/XML%E6%96%87%E4%BB%B6%E8%BD%ACTXT/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-06 19:33:20" itemprop="dateModified" datetime="2022-04-06T19:33:20+08:00">2022-04-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="XML文件转TXT"><a href="#XML文件转TXT" class="headerlink" title="XML文件转TXT"></a>XML文件转TXT</h2><p>网络上有很多xml转txt的文章，不过有的xml文件不包括size信息，即图片本身的宽高，因此在前辈的基础上添加了图像size的读取，无需对xml文件进行处理，直接将图片的宽高读到数组中，这个方法的局限性在于标签和图片必须一一对应，考虑到数据集通常是规整的，因此无伤大雅。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">classes = [<span class="string">&quot;holothurian&quot;</span>, <span class="string">&quot;echinus&quot;</span>, <span class="string">&quot;scallop&quot;</span>, <span class="string">&quot;starfish&quot;</span>]  <span class="comment"># 类别</span></span><br><span class="line">xml_path = <span class="string">&quot;xml标签文件夹路径&quot;</span></span><br><span class="line">txt_path = <span class="string">&quot;txt标签存储路径&quot;</span></span><br><span class="line">image_path = <span class="string">&quot;图像文件夹路径&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将原有的xmax,xmin,ymax,ymin换为x,y,w,h</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">size, box</span>):</span><br><span class="line">    dw = <span class="number">1.</span> / size[<span class="number">0</span>]</span><br><span class="line">    dh = <span class="number">1.</span> / size[<span class="number">1</span>]</span><br><span class="line">    x = (box[<span class="number">0</span>] + box[<span class="number">1</span>]) / <span class="number">2.0</span></span><br><span class="line">    y = (box[<span class="number">2</span>] + box[<span class="number">3</span>]) / <span class="number">2.0</span></span><br><span class="line">    w = box[<span class="number">1</span>] - box[<span class="number">0</span>]</span><br><span class="line">    h = box[<span class="number">3</span>] - box[<span class="number">2</span>]</span><br><span class="line">    x = x * dw</span><br><span class="line">    w = w * dw</span><br><span class="line">    y = y * dh</span><br><span class="line">    h = h * dh</span><br><span class="line">    <span class="keyword">return</span> (x, y, w, h)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入时图像和图像的宽高</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_annotation</span>(<span class="params">image_id, width, hight</span>):</span><br><span class="line">    in_file = <span class="built_in">open</span>(xml_path + <span class="string">&#x27;\\&#123;&#125;.xml&#x27;</span>.<span class="built_in">format</span>(image_id), encoding=<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">    out_file = <span class="built_in">open</span>(txt_path + <span class="string">&#x27;\\&#123;&#125;.txt&#x27;</span>.<span class="built_in">format</span>(image_id), <span class="string">&#x27;w&#x27;</span>)  <span class="comment"># 生成txt格式文件</span></span><br><span class="line">    tree = ET.parse(in_file)</span><br><span class="line">    root = tree.getroot()</span><br><span class="line">    size = root.find(<span class="string">&#x27;size&#x27;</span>)	<span class="comment"># 此处是获取原图的宽高，便于后续的归一化操作</span></span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        w = <span class="built_in">int</span>(size.find(<span class="string">&#x27;width&#x27;</span>).text)</span><br><span class="line">        h = <span class="built_in">int</span>(size.find(<span class="string">&#x27;height&#x27;</span>).text)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        w = width</span><br><span class="line">        h = hight</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> root.<span class="built_in">iter</span>(<span class="string">&#x27;object&#x27;</span>):</span><br><span class="line">        cls = obj.find(<span class="string">&#x27;name&#x27;</span>).text</span><br><span class="line">        <span class="comment"># print(cls)</span></span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> classes:</span><br><span class="line">            <span class="built_in">print</span>(cls)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        cls_id = classes.index(cls)</span><br><span class="line">        xmlbox = obj.find(<span class="string">&#x27;bndbox&#x27;</span>)</span><br><span class="line">        b = (<span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;xmin&#x27;</span>).text), </span><br><span class="line">             <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;xmax&#x27;</span>).text), </span><br><span class="line">             <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;ymin&#x27;</span>).text),</span><br><span class="line">             <span class="built_in">float</span>(xmlbox.find(<span class="string">&#x27;ymax&#x27;</span>).text))</span><br><span class="line">        bb = convert((w, h), b)</span><br><span class="line">        out_file.write(<span class="built_in">str</span>(cls_id) + <span class="string">&quot; &quot;</span> + <span class="string">&quot; &quot;</span>.join([<span class="built_in">str</span>(a) <span class="keyword">for</span> a <span class="keyword">in</span> bb]) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处获取图像宽高的数组，tqdm为处理的可视化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_size</span>(<span class="params">path</span>):</span><br><span class="line">    image = os.listdir(path)</span><br><span class="line">    w_l, h_l = [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tqdm(image):</span><br><span class="line">        <span class="keyword">if</span> i.endswith(<span class="string">&#x27;jpg&#x27;</span>):</span><br><span class="line">            h_l.append(cv2.imread(os.path.join(path, i)).shape[<span class="number">0</span>])</span><br><span class="line">            w_l.append(cv2.imread(os.path.join(path, i)).shape[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> w_l, h_l</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历xml文件，将对应的宽高输入convert_annotation方法</span></span><br><span class="line"><span class="keyword">if</span> __name__  == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    img_xmls = os.listdir(xml_path)</span><br><span class="line">    w, h = image_size(image_path)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> img_xml <span class="keyword">in</span> img_xmls:</span><br><span class="line">        label_name = img_xml.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(label_name)</span><br><span class="line">        convert_annotation(label_name, w[i], h[i])</span><br><span class="line">        i += <span class="number">1</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/ros%20serial%E7%9A%84%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/ros%20serial%E7%9A%84%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-03 20:54:41" itemprop="dateModified" datetime="2021-11-03T20:54:41+08:00">2021-11-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43046653/article/details/84334529">这篇文章</a>提到可以使用两种方法对Arduino开发板进行通信，一种是基于ros通讯机制的rosserial进行通信，一种是直接使用串口进行通信。两种方法各有优缺点，本文对两种方法进行了简单的整理和总结。</p>
<h1 id="rosserial的使用"><a href="#rosserial的使用" class="headerlink" title="rosserial的使用"></a>rosserial的使用</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38441692/article/details/97814194">这篇文章</a>较为详细的演示了如何使用rosserial arduino，首先需要安装rosserial arduino。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install ros-(rosvision)-rosserial-arduino</span><br><span class="line">sudo apt-get install ros-(rosvision)-rosserial</span><br></pre></td></tr></table></figure>

<p>其次在Arduino库中安装ros_lib，需要在Arduino库目录下的sketchbook&#x2F;libraries下执行以下命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rosrun rosserial_arduino make_libraries.py</span><br></pre></td></tr></table></figure>

<p>随后就可以在arduino开发板上使用ROS库下的方法了，如创建发布者和订阅者等等。由于使用了ROS库下的方法，rosserial可以使得arduino发布TF树、自身传感器数值等信息，且不需要修改串口号等内容，即插即用。</p>
<h1 id="串口的使用"><a href="#串口的使用" class="headerlink" title="串口的使用"></a>串口的使用</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014695839/article/details/81209082">这篇文章</a>演示了如何使用串口直接与arduino相互通讯，串口的使用相对快捷简单些，且不需要对已经编写好的Arduino开发板进行修改。只需要了解串口信息的含义，便可以通过串口实现机械臂的控制。缺点就是需要对ROS系统的消息进行整理，转化为字符串传输给开发板。</p>
<p>ROS与Arduino之间的通信相对简单，更为重要的是如何获取、处理两者之间的信息。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/Arduino%E6%8E%A7%E5%88%B6PWM%E8%88%B5%E6%9C%BA%E7%9A%84%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/Arduino%E6%8E%A7%E5%88%B6PWM%E8%88%B5%E6%9C%BA%E7%9A%84%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-02 14:58:46" itemprop="dateModified" datetime="2021-11-02T14:58:46+08:00">2021-11-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h1><p>2周前用700不到买了一个六自由度的舵机机械臂作为视觉伺服算法的平台，商家提供的是可视化界面的控制平台，需要对他的源码进行解读与分析，便于后面接入ROS平台。感谢商家提供的视频教程和<a target="_blank" rel="noopener" href="http://www.taichi-maker.com/">太极创客</a>在B站上传的免费课程，使得对嵌入式零基础的我可以快速上手Arduino的开发。</p>
<h1 id="Arduino-IDE的安装"><a href="#Arduino-IDE的安装" class="headerlink" title="Arduino IDE的安装"></a>Arduino IDE的安装</h1><p>此处分为Windows和Ubuntu下的Arduino安装，在Windows系统下进行Arduino的学习相对方便些<del>（说白了就是用习惯了）</del>。这里仅简述Arduino IDE的安装，具体如何使用IDE需要参考别处的教程，推荐观看<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV164411J7GE">太极创客</a>的教程，IDE的使用在Windows和Ubuntu下几乎没有差别。</p>
<p>首先去<a target="_blank" rel="noopener" href="https://www.arduino.cc/en/software">Arduino官网</a>下载安装包，Windows系统下推荐下载exe文件进行安装，安装路径随意。安装完成后便可双击桌面的Arduino程序进入IDE，如果需要使用商家提供的库，需要将商家提供的libraries文件夹复制到Arduino的安装路径下。除了IDE的安装，还需要安装串口驱动，我这里使用的是CH341SER的串口驱动，一切完成后便可以对Arduino进行开发。</p>
<p>Ubuntu系统下不推荐使用apt-get指令下载安装Arduino，此版本过低。根据Linux系统在官网下载最新的安装包，将安装包解压至&#x2F;opt文件夹下，随后进入安装目录给install.sh可执行权限，并运行，此处以1.8.16为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/arduino-1.8.16/</span><br><span class="line">sudo chmod +x install.sh</span><br><span class="line">sudo ./install.sh</span><br></pre></td></tr></table></figure>

<p>Ubuntu自带了串口驱动，如果进入IDE无法识别串口，需要先给予权限，再移除自带程序brltty，此处username为自己的用户名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown username /dev/ttyUSB0</span><br><span class="line">sudo apt-get remove brltty</span><br></pre></td></tr></table></figure>

<h1 id="LED和蜂鸣器的使用"><a href="#LED和蜂鸣器的使用" class="headerlink" title="LED和蜂鸣器的使用"></a>LED和蜂鸣器的使用</h1><p>此处重点是记录如何对LED和蜂鸣器进行编程使用，相当于Arduino编程的入门，具体代码如下。</p>
<p><code>LED闪烁</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******宏定义LED管脚映射表*******/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_PIN 13</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******宏定义LED快捷指令表*******/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED   digitalRead(LED_PIN)      <span class="comment">//读取LED信号灯状态</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_ON() digitalWrite(LED_PIN,LOW)   <span class="comment">//LED信号灯点亮，低电平0</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED_OFF() digitalWrite(LED_PIN,HIGH)    <span class="comment">//LED信号灯熄灭，高电平1</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******LED初始化*******/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">led_init</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">pinMode</span>(LED_PIN,OUTPUT);          <span class="comment">//设置引脚为输出模式，初始状态为关闭</span></span><br><span class="line">  <span class="built_in">LED_OFF</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******LED变换一次*******/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">led_change</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(LED==<span class="number">1</span>) <span class="built_in">LED_ON</span>();</span><br><span class="line">  <span class="keyword">else</span> <span class="built_in">LED_OFF</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******LED按1秒间隔闪烁*******/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">led_loop</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> systick_ms_bak = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">millis</span>() - systick_ms_bak &gt; <span class="number">500</span>) &#123;	<span class="comment">//millis()为当前时间，在loop方法中尽量使用此方法做时间间隔，而非delay()方法</span></span><br><span class="line">    systick_ms_bak = <span class="built_in">millis</span>();</span><br><span class="line">    <span class="built_in">led_change</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">led_init</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">led_loop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>蜂鸣器鸣叫提醒</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******BEEP管脚映射表*******/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEP_PIN 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******BEEP快捷指令表*******/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEP_ON() digitalWrite(BEEP_PIN,HIGH)   <span class="comment">//蜂鸣器BEEP打开,高电平1</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEP_OFF() digitalWrite(BEEP_PIN,LOW)  <span class="comment">//蜂鸣器BEEP关闭，低电平0</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******BEEP初始化*******/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">beep_init</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">pinMode</span>(BEEP_PIN,OUTPUT);         <span class="comment">//设置引脚为输出模式</span></span><br><span class="line">  <span class="built_in">BEEP_OFF</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******BEEP短鸣两声*******/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">beep_short</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="built_in">BEEP_ON</span>();<span class="built_in">delay</span>(<span class="number">100</span>);<span class="built_in">BEEP_OFF</span>();<span class="built_in">delay</span>(<span class="number">100</span>);</span><br><span class="line">  <span class="built_in">BEEP_ON</span>();<span class="built_in">delay</span>(<span class="number">100</span>);<span class="built_in">BEEP_OFF</span>();<span class="built_in">delay</span>(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">beep_init</span>();</span><br><span class="line">    <span class="built_in">beep_short</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先需要对引脚进行初始化，才能使用对应引脚的元器件，其中setup方法下的代码只运行一遍，而loop方法下的代码会重复运行。因此，如果需要在loop方法中嵌套循环需要添加判断语句，以免陷入内循环而无法退出；同样的如果在loop方法下使用delay做时间间隔，则后续代码需要等待delay设定的时间后才能运行，极大的影响程序运行的速度。此外，LED开关和蜂鸣器开关的高低电平仍存在一些困惑，甚至商家给的例程也有些问题，在做高低电平判断时会出现对不上的情况，这一点还有待进一步学习。</p>
<h1 id="串口的使用"><a href="#串口的使用" class="headerlink" title="串口的使用"></a>串口的使用</h1><p>这里将有用的串口信息存放到数组receive_data中，由data_ready做判断是否需要将数组送入别的方法做字符串的整理和筛选，具体代码如下：</p>
<p><code>串口的使用</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DATA_MAX_SIZE 12	<span class="comment">//起始符到终止符的总字符数</span></span></span><br><span class="line"></span><br><span class="line">u8 receive_data[DATA_MAX_SIZE]=&#123;<span class="number">0</span>&#125;, receive_data_index, data_ready，servo_index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****串口初始化*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">serial_init</span><span class="params">(u32 baud)</span></span>&#123;</span><br><span class="line">  Serial.<span class="built_in">begin</span>(baud);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****串口发送字节*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">send_byte</span><span class="params">(u8 dat)</span> </span>&#123;</span><br><span class="line">  Serial.<span class="built_in">write</span>(dat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****串口发送字符串*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">send_string</span><span class="params">(<span class="type">char</span> *s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (*s) &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(*s++);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****串口中断，会在loop循环结束时自动运行，即每次循环执行一次*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">serialEvent</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> u8 temp_data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(Serial.<span class="built_in">available</span>()) &#123;</span><br><span class="line">    temp_data = Serial.<span class="built_in">read</span>();</span><br><span class="line">    <span class="comment">/*******返回接收到的指令*******/</span></span><br><span class="line">    <span class="built_in">send_byte</span>(temp_data);</span><br><span class="line">    <span class="comment">/*******若正在执行命令，则不存储命令*******/</span></span><br><span class="line">    <span class="keyword">if</span>(data_ready) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">/*******检测命令起始*******/</span></span><br><span class="line">    <span class="keyword">if</span>(temp_data == <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">      receive_data_index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*******检测命令结尾*******/</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(temp_data == <span class="string">&#x27;!&#x27;</span>)&#123;</span><br><span class="line">      receive_data[receive_data_index] = temp_data;</span><br><span class="line">      Serial.<span class="built_in">println</span>();</span><br><span class="line">      data_ready = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    receive_data[receive_data_index++] = temp_data;</span><br><span class="line">    <span class="comment">/*******检测命令长度*******/</span></span><br><span class="line">    <span class="keyword">if</span>(receive_data_index &gt;= DATA_MAX_SIZE) &#123;</span><br><span class="line">      receive_data_index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****处理串口保存下来的数据$F1000T1000!*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">data_loop</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(data_ready) &#123;</span><br><span class="line">    <span class="type">int</span> time_temp=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> aim_temp=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt; <span class="built_in">sizeof</span>(receive_data)<span class="number">-1</span>; j++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;A&#x27;</span>) servo_index=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;B&#x27;</span>) servo_index=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;C&#x27;</span>) servo_index=<span class="number">2</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;D&#x27;</span>) servo_index=<span class="number">3</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;E&#x27;</span>) servo_index=<span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;F&#x27;</span>) servo_index=<span class="number">5</span>;</span><br><span class="line">      <span class="keyword">if</span>(receive_data[j]==<span class="string">&#x27;T&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">4</span>;k++)&#123;</span><br><span class="line">            j++;</span><br><span class="line">            <span class="keyword">if</span>(k==<span class="number">0</span>)&#123;</span><br><span class="line">              time_temp=time_temp+(receive_data[j]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">1000</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              time_temp=time_temp+(receive_data[j]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">1000</span>/<span class="built_in">pow</span>(<span class="number">10</span>,k);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(j == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">4</span>;k++)&#123;</span><br><span class="line">          j++;</span><br><span class="line">          <span class="keyword">if</span>(k==<span class="number">0</span>)&#123;</span><br><span class="line">            aim_temp=aim_temp+(receive_data[j]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">1000</span>;</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            aim_temp=aim_temp+(receive_data[j]-<span class="string">&#x27;0&#x27;</span>)*<span class="number">1000</span>/<span class="built_in">pow</span>(<span class="number">10</span>,k);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    time_data[servo_index]=(<span class="type">int</span>)time_temp;</span><br><span class="line">    aim_data[servo_index]=(<span class="type">int</span>)aim_temp;</span><br><span class="line">    <span class="built_in">servo_run</span>(servo_index,aim_data[servo_index],time_data[servo_index]);	<span class="comment">//见舵机部分</span></span><br><span class="line">    receive_data_index = <span class="number">0</span>;</span><br><span class="line">    data_ready = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(receive_data, <span class="number">0</span>, <span class="built_in">sizeof</span>(receive_data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">serial_init</span>(<span class="number">115200</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">data_loop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码基本是参考商家提供的源码进行了些许修改，baud为波特率即一秒处理多少字节的数据。此外，可以不将串口的数据存为数组，改为逐个的将串口数据读取判断，且可以使用Serial.parseInt()将一段数字直接取出，无需将字符串的数据重新整理，但代码整体会显得较为臃肿，一个方法内需要有读取数据和处理数据两个功能。</p>
<h1 id="Servo库的使用"><a href="#Servo库的使用" class="headerlink" title="Servo库的使用"></a>Servo库的使用</h1><p>此处使用的是舵机（Servo），通过PWM信号驱动，需要每20ms接受一次信号。因此，为了实现舵机控制的顺滑性，需要对一个角度动作进行拆解连续控制，以下代码可供参考：</p>
<p><code>舵机的连续控制</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Servo.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATA_MAX_SIZE 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVO_NUM 6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="type">int</span> aim;</span><br><span class="line">  <span class="type">float</span> cur;</span><br><span class="line">  <span class="type">float</span> inc;</span><br><span class="line">  <span class="type">int</span> time_set;</span><br><span class="line">&#125;servo_struct;</span><br><span class="line"></span><br><span class="line">servo_struct servo_data[SERVO_NUM];</span><br><span class="line">u8 servo_index;</span><br><span class="line"></span><br><span class="line">byte  servo_pin[SERVO_NUM] = &#123;<span class="number">7</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span> ,<span class="number">8</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> aim_data[SERVO_NUM];</span><br><span class="line"><span class="type">int</span> time_data[SERVO_NUM];</span><br><span class="line"></span><br><span class="line">Servo myservo[SERVO_NUM];	<span class="comment">//创建舵机类数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*****舵机的初始化*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">servo_init</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(byte i = <span class="number">0</span>; i &lt; SERVO_NUM; i ++) &#123;</span><br><span class="line">    myservo[i].<span class="built_in">attach</span>(servo_pin[i]);</span><br><span class="line">    myservo[i].<span class="built_in">writeMicroseconds</span>(servo_data[i].aim);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****舵机运行index（编号）、aim（目标角度）、time（运行时间）*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">servo_run</span><span class="params">(u8 index, <span class="type">int</span> aim, <span class="type">int</span> time_set)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(index &lt; SERVO_NUM &amp;&amp; (aim&lt;=<span class="number">2500</span>)&amp;&amp; (aim&gt;=<span class="number">500</span>) &amp;&amp; (time_set&lt;<span class="number">10000</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(aim&gt;<span class="number">2500</span>)  aim=<span class="number">2500</span>;</span><br><span class="line">    <span class="keyword">if</span>(aim&lt;<span class="number">500</span>)   aim=<span class="number">500</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(time_set &lt; <span class="number">20</span>) &#123;</span><br><span class="line">      servo_data[index].aim = aim;</span><br><span class="line">      servo_data[index].cur = aim;</span><br><span class="line">      servo_data[index].inc = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      servo_data[index].aim = aim;</span><br><span class="line">      servo_data[index].time_set = time_set;</span><br><span class="line">      servo_data[index].inc = (servo_data[index].aim-servo_data[index].cur)/(time_set/<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*****循环处理舵机的指令*****/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">servo_loop</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">long</span> <span class="type">long</span> systick_ms_bak = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">millis</span>() - systick_ms_bak &gt; <span class="number">20</span>) &#123;	<span class="comment">//每隔20ms控制一次舵机</span></span><br><span class="line">    systick_ms_bak = <span class="built_in">millis</span>();</span><br><span class="line">    <span class="keyword">for</span>(byte i=<span class="number">0</span>; i&lt;SERVO_NUM; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(servo_data[i].inc != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(servo_data[i].aim&gt;<span class="number">2500</span>)  servo_data[i].aim=<span class="number">2500</span>;</span><br><span class="line">        <span class="keyword">if</span>(servo_data[i].aim&lt;<span class="number">500</span>)   servo_data[i].aim=<span class="number">500</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">abs</span>(servo_data[i].aim - servo_data[i].cur) &lt;= <span class="built_in">abs</span>(servo_data[i].inc)) &#123;</span><br><span class="line">          myservo[i].<span class="built_in">writeMicroseconds</span>(servo_data[i].aim);</span><br><span class="line">          servo_data[i].cur = servo_data[i].aim;</span><br><span class="line">          servo_data[i].inc = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          servo_data[i].cur += servo_data[i].inc;</span><br><span class="line">          myservo[i].<span class="built_in">writeMicroseconds</span>(<span class="built_in">int</span>(servo_data[i].cur));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">servo_init</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">servo_loop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与串口的代码相同，此处也是参考商家的源码进行整理，重点还是以实现功能为主。此处引入舵机运行的时间并非最佳，后续还可以根据PID算法对各个角度的运行时间进行优化，使得机械臂能够更加快速、顺滑地到达指定坐标。此外，舵机的自动控制需要引入更多的传感器和算法，而指令控制需要引入上一小节串口数据处理的相关方法。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>一开始使用的是STM32开发板，但发现学习成本较高，即花费时间较多，所以后面转到相对简单些的Arduino开发环境。除了相对更简单的优点外，Arduino和ROS的结合也是比较容易，有现成的ros-serial将开发板作为一个通讯节点。在学习Arduino开发的过程中，发现C++的基础相对薄弱，如u8对象、宏定义和指针的使用等。且由于Arduino在项目中仅仅是作为平台，所以并没有深入的进一步学习进阶的内容，相关的代码也较为简单，有许多地方需要优化。</p>
<p>机械臂的平台搭建至此完成了近一半，下一步需要学习ros-serial和move-it!的使用，从而将机械臂平台接入ROS系统。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/16/realsense%E5%9C%A8%E6%9C%BA%E6%A2%B0%E8%87%82%E4%B8%8A%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Paliya">
      <meta itemprop="description" content="欢迎来到我的博客！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paliya's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/realsense%E5%9C%A8%E6%9C%BA%E6%A2%B0%E8%87%82%E4%B8%8A%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-16 13:20:44" itemprop="dateCreated datePublished" datetime="2022-07-16T13:20:44+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-13 18:59:19" itemprop="dateModified" datetime="2021-12-13T18:59:19+08:00">2021-12-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="realsense在机械臂上的配置与安装"><a href="#realsense在机械臂上的配置与安装" class="headerlink" title="realsense在机械臂上的配置与安装"></a>realsense在机械臂上的配置与安装</h1><p>早在上半年导师就给了一个realsense d455做机器视觉相关的内容，此次将其配置到ros环境下的机械臂末端组成eye-in-hand机械臂平台，其中主要任务是realsense在ros环境下的配置和相机坐标系与机械臂末端的固定。</p>
<h1 id="realsense相机的配置"><a href="#realsense相机的配置" class="headerlink" title="realsense相机的配置"></a>realsense相机的配置</h1><p><a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/librealsense/blob/master/doc/distribution_linux.md">官网</a>很好的介绍了realsense d455相机的配置流程，且现在英特尔官方的安装包已经更新添加了d455相机相关的内容，便于我们调用其坐标以实现相机的配置。官网的安装方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE || sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE In case the public key still cannot be retrieved, check and specify proxy settings: export http_proxy=&quot;http://&lt;proxy&gt;:&lt;port&gt;&quot;</span><br><span class="line"></span><br><span class="line">sudo add-apt-repository &quot;deb https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main&quot; -u</span><br><span class="line"></span><br><span class="line">sudo apt-get install librealsense2-dkms</span><br><span class="line">sudo apt-get install librealsense2-utils</span><br><span class="line"></span><br><span class="line">sudo apt-get install librealsense2-dev</span><br><span class="line">sudo apt-get install librealsense2-dbg</span><br></pre></td></tr></table></figure>

<p>完成安装后可以在终端输入”realsense-viewer”打开自带的预览界面，完成SDK的安装后还需要在工作空间配置realsense-ros，<a target="_blank" rel="noopener" href="https://github.com/IntelRealSense/realsense-ros">官网的方法</a>也很简单，首先需要将realsense-ros的功能包解压或clone到工作空间的src下，随后退回到工作空间的根目录进行catkin_make即可完成配置，官网是新建了一个工作空间，指令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/catkin_ws/src</span><br><span class="line">cd ~/catkin_ws/src/</span><br><span class="line"></span><br><span class="line">git clone https://github.com/IntelRealSense/realsense-ros.git</span><br><span class="line">cd realsense-ros/</span><br><span class="line">git checkout `git tag | sort -V | grep -P &quot;^2.\d+\.\d+&quot; | tail -1`</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">catkin_init_workspace</span><br><span class="line">cd ..</span><br><span class="line">catkin_make clean</span><br><span class="line">catkin_make -DCATKIN_ENABLE_TESTING=False -DCMAKE_BUILD_TYPE=Release</span><br><span class="line">catkin_make install</span><br><span class="line"></span><br><span class="line">echo &quot;source ~/catkin_ws/devel/setup.bash&quot; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>将realsense相机插上后运行”roslaunch realsense2_camera rs_camera.launch”即可打开相机进行图像和imu等内容的发布。在配置机械臂之前，我参考了<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40186909/article/details/113104595">这篇文章</a>对realsense相机有了较为深入的了解，且试着跑了一下VINS-Fusion效果也还可以，下面就是将realsense与机械臂进行连接。</p>
<h1 id="机械臂连接realsense"><a href="#机械臂连接realsense" class="headerlink" title="机械臂连接realsense"></a>机械臂连接realsense</h1><p>完成先前的moveit机械臂文件搭建后，只需要添加机械臂末端坐标与摄像头坐标的关系即可将摄像头固定到机械臂末端。可以在moveit的launch文件中添加静态坐标关系，或采用<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38649880/article/details/89298996">这篇文章</a>的其他方法，以我的机械臂为例launch中的代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">&quot;tf&quot;</span> <span class="attr">name</span>=<span class="string">&quot;static_transform_publisher&quot;</span> <span class="attr">name</span>=<span class="string">&quot;camera_link&quot;</span> </span></span><br><span class="line"><span class="tag">      <span class="attr">args</span>=<span class="string">&quot;x y z yaw pitch roll frame_id child_frame_id 100&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中(x, y, z, yaw, pitch, roll)为child_frame（摄像头坐标）和frame（机械臂末端坐标）的坐标变换关系，随后在终端中逐个开启各个节点，指令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">roslaunch realsense2_camera rs_camera.launch</span><br><span class="line">roslaunch myrobot_moveit demo.launch</span><br><span class="line">rosrun myserial get_data</span><br><span class="line">rosrun myserial serial_port</span><br></pre></td></tr></table></figure>

<p>将所有指令输入完成后需要在moveit的rviz中添加相机的pointcloud2节点，从而实现在rivz的3D图像中显示摄像头的点云数据，最后可以获得的效果如视频所示：</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>至此，最简单的eye-in-hand的机械臂平台已经建立完成，接下来需要学习CV相关的知识了，这里推荐<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1nz4y197Qv?p=1">北邮鲁老师的课程</a>，相对全面且易懂一些。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Paliya</p>
  <div class="site-description" itemprop="description">欢迎来到我的博客！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Paliya</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
